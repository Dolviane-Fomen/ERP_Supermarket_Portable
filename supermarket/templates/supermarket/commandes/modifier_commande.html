<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier Commande</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #06beb6 0%, #48b1bf 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(6, 190, 182, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(72, 177, 191, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(26, 188, 156, 0.2) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            overflow: visible;
            margin-bottom: 20px;
        }

        .form-header {
            background: linear-gradient(135deg, #06beb6 0%, #48b1bf 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            position: relative;
        }

        .form-header h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .form-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1em;
        }

        .form-content {
            padding: 40px;
            overflow: visible;
        }

        .form-group {
            margin-bottom: 35px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            position: relative;
            transition: all 0.3s ease;
        }

        .form-group:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .form-group-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group-title i {
            color: #06beb6;
            font-size: 1.1em;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-row.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .required {
            color: #dc3545;
            font-weight: bold;
        }

        .form-field input,
        .form-field select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background: white;
            color: #495057;
            width: 100%;
            box-sizing: border-box;
        }

        .form-field input:focus,
        .form-field select:focus {
            outline: none;
            border-color: #06beb6;
            box-shadow: 0 0 0 3px rgba(6, 190, 182, 0.1);
            transform: translateY(-1px);
        }

        .help-text {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }

        .articles-table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(6, 190, 182, 0.1);
            margin-bottom: 20px;
        }

        .articles-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .articles-table th {
            background: linear-gradient(135deg, #06beb6 0%, #48b1bf 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .articles-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(6, 190, 182, 0.1);
            vertical-align: middle;
            color: #555;
            font-size: 0.95rem;
        }

        .articles-table tbody tr:hover {
            background: rgba(6, 190, 182, 0.05);
        }

        .quantity-input {
            width: 100px;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .quantity-input:focus {
            outline: none;
            border-color: #06beb6;
            box-shadow: 0 0 0 2px rgba(6, 190, 182, 0.1);
        }

        .total-cell {
            font-weight: 600;
            color: #28a745;
            text-align: right;
        }

        .btn-delete-line {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .btn-delete-line:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .no-articles-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .no-articles-message i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
            display: block;
        }

        .total-section {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 35px;
            text-align: center;
        }

        .total-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.3em;
            font-weight: 700;
        }

        .total-amount {
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }

        .btn {
            padding: 15px 30px;
            border-radius: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            text-align: center;
            justify-content: center;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #06beb6 0%, #48b1bf 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(6, 190, 182, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 190, 182, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-error,
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }

        .info-display {
            background: #e9ecef;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            color: #495057;
            border: 2px solid #e9ecef;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 240px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background 0.2s ease;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 3px;
        }

        .search-result-details {
            font-size: 0.85em;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .form-row,
            .form-row.triple {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .container {
                padding: 10px;
            }
            
            .form-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <div class="form-header">
                <h2><i class="fas fa-edit"></i> Modifier Commande</h2>
                <p>Modifier les informations de la commande</p>
            </div>

            <div class="form-content">
                <form method="POST" id="commande-form">
                    {% csrf_token %}
                    <input type="hidden" id="articles_data" name="articles_data" value="">
                    
                    <!-- Messages -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            <i class="fas fa-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                    <!-- Informations générales -->
                    <div class="form-group">
                        <div class="form-group-title">
                            <i class="fas fa-info-circle"></i>
                            Informations Générales
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="date">
                                    <i class="fas fa-calendar"></i>
                                    Date <span class="required">*</span>
                                </label>
                                <input type="date" id="date" name="date" 
                                       value="{{ commande.date|date:'Y-m-d' }}" required>
                                <div class="help-text">Date de la commande</div>
                            </div>
                            
                            <div class="form-field">
                                <label for="heure">
                                    <i class="fas fa-clock"></i>
                                    Heure <span class="required">*</span>
                                </label>
                                <input type="time" id="heure" name="heure" 
                                       value="{{ commande.heure|time:'H:i' }}" required>
                                <div class="help-text">Heure de la commande</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label for="etat_commande">
                                    <i class="fas fa-tasks"></i>
                                    État <span class="required">*</span>
                                </label>
                                <select id="etat_commande" name="etat_commande" required>
                                    <option value="en_attente" {% if commande.etat_commande == 'en_attente' %}selected{% endif %}>En attente</option>
                                    <option value="validee" {% if commande.etat_commande == 'validee' %}selected{% endif %}>Validée</option>
                                    <option value="en_livraison" {% if commande.etat_commande == 'en_livraison' %}selected{% endif %}>En livraison</option>
                                    <option value="livree" {% if commande.etat_commande == 'livree' %}selected{% endif %}>Livrée</option>
                                    <option value="annulee" {% if commande.etat_commande == 'annulee' %}selected{% endif %}>Annulée</option>
                                </select>
                                <div class="help-text">État de la commande</div>
                            </div>

                            <div class="form-field">
                                <label>
                                    <i class="fas fa-user"></i>
                                    Client
                                </label>
                                <div class="info-display">
                                    {{ commande.client.intitule }}
                                </div>
                                <div class="help-text">Client associé à cette commande</div>
                            </div>
                        </div>
                    </div>

                    <!-- Articles de la Commande -->
                    <div class="form-group">
                        <div class="form-group-title">
                            <i class="fas fa-boxes"></i>
                            Articles de la Commande
                        </div>

                        <div class="article-selector" style="position: relative; overflow: visible;">
                            <div class="form-field">
                                <label for="article_search">
                                    <i class="fas fa-search"></i>
                                    Rechercher un Article
                                </label>
                                <input type="text" id="article_search" placeholder="Tapez au moins 1 lettre pour rechercher" onkeyup="searchArticles()">
                                <div class="help-text">Commencez à taper pour rechercher un article</div>
                                <div id="search_results" class="search-results"></div>
                            </div>
                        </div>
                        
                        <div class="articles-table-container">
                            <table id="articles-table" class="articles-table">
                            <thead>
                                <tr>
                                        <th>Désignation</th>
                                        <th>Référence</th>
                                    <th>Quantité</th>
                                        <th>Prix Unitaire</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                    {% if commandes_groupe %}
                                {% for cmd in commandes_groupe %}
                                        <tr data-commande-id="{{ cmd.id }}" data-article-id="{{ cmd.article.id }}">
                                    <td>{{ cmd.article.designation }}</td>
                                            <td>{{ cmd.article.reference_article|default:"-" }}</td>
                                            <td>
                                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                                    <div style="font-size: 0.85em; color: #6c757d; font-style: italic;">
                                                        Actuel: <span id="quantite-actuelle-{{ cmd.id }}">{{ cmd.quantite|floatformat:3 }}</span>
                                                    </div>
                                                    <input type="number" 
                                                           class="quantity-input" 
                                                           name="quantite_{{ cmd.id }}" 
                                                           value="{{ cmd.quantite|floatformat:3 }}" 
                                                           min="0" 
                                                           step="0.001" 
                                                           data-commande-id="{{ cmd.id }}"
                                                           data-quantite-actuelle="{{ cmd.quantite }}"
                                                           onchange="updateRowTotal(this.closest('tr'))" 
                                                           oninput="updateRowTotal(this.closest('tr'))"
                                                           style="width: 100px; padding: 8px; border: 2px solid #e1e8ed; border-radius: 5px; text-align: center;">
                                                </div>
                                            </td>
                                            <td>{{ cmd.article.prix_vente|floatformat:0 }} FCFA</td>
                                            <td>
                                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                                    <div style="font-size: 0.85em; color: #6c757d; font-style: italic;">
                                                        Actuel: <span id="prix-actuel-{{ cmd.id }}">{{ cmd.prix_total|floatformat:0 }}</span> FCFA
                                                    </div>
                                                    <span class="total-cell" id="prix-total-{{ cmd.id }}" style="color: #06beb6; font-size: 1.1em;">{{ cmd.prix_total|floatformat:0 }}</span> FCFA
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn-delete-line" onclick="deleteCommande('{{ cmd.id }}', '{{ cmd.article.designation|escapejs }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                    {% else %}
                                        <tr class="no-articles-row">
                                            <td colspan="6" class="no-articles-message">
                                                <i class="fas fa-info-circle"></i>
                                                <p>Aucun article sélectionné</p>
                                            </td>
                                        </tr>
                                    {% endif %}
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- Informations financières -->
                    <div class="form-group">
                        <div class="form-group-title">
                            <i class="fas fa-calculator"></i>
                            Informations Financières
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="prix_total_global">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Prix Total Global (FCFA) <span class="required">*</span>
                                </label>
                                <input type="number" id="prix_total_global" name="prix_total_global" 
                                       value="{{ prix_total|floatformat:2 }}" 
                                       min="0" step="0.01" required readonly>
                                <div class="help-text">Montant total calculé automatiquement</div>
                            </div>

                            <div class="form-field">
                                <label>
                                    <i class="fas fa-building"></i>
                                    Agence
                                </label>
                                <div class="info-display">
                                    {{ agence.nom_agence }}
                                </div>
                                <div class="help-text">Agence associée à cette commande</div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer les Modifications
                        </button>
                        <a href="{% url 'detail_commande' commande.id %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Annuler
                        </a>
                        <a href="{% url 'consulter_commandes' %}" class="btn btn-secondary">
                            <i class="fas fa-list"></i> Retour à la Liste
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
// Fonction pour mettre à jour le total d'une ligne
function updateRowTotal(row) {
    const quantiteInput = row.querySelector('.quantity-input');
    const prixUnitaireText = row.querySelector('td:nth-child(4)').textContent.replace(/[^\d,]/g, '').replace(',', '');
    const prixUnitaire = parseFloat(prixUnitaireText) || 0;
    const quantite = parseFloat(quantiteInput.value) || 0;
    const total = quantite * prixUnitaire;
    
    // Mettre à jour le total de la ligne
    const totalCell = row.querySelector('.total-cell');
    if (totalCell) {
        totalCell.textContent = total.toFixed(0) + ' FCFA';
    }
    
    // Mettre à jour l'affichage du prix total avec l'ID si c'est une commande existante
    const commandeId = quantiteInput.getAttribute('data-commande-id');
    if (commandeId) {
        const prixTotalElement = document.getElementById(`prix-total-${commandeId}`);
        if (prixTotalElement) {
            prixTotalElement.textContent = Number(total).toLocaleString('fr-FR');
        }
        
        // Mettre en évidence si la quantité a changé
        const quantiteActuelle = parseFloat(quantiteInput.getAttribute('data-quantite-actuelle')) || 0;
        if (Math.abs(quantite - quantiteActuelle) > 0.001) {
            quantiteInput.style.borderColor = '#ffc107';
            quantiteInput.style.backgroundColor = '#fff3cd';
        } else {
            quantiteInput.style.borderColor = '#e1e8ed';
            quantiteInput.style.backgroundColor = '#fff';
        }
    }
    
    // Mettre à jour le total global
    updateTotalGlobal();
}

// Fonction pour mettre à jour le total global
function updateTotalGlobal() {
    let totalGlobal = 0;
    
    // Calculer le total à partir de toutes les lignes avec articles
    const rows = document.querySelectorAll('#articles-table tbody tr[data-commande-id], #articles-table tbody tr[data-article-id]');
    rows.forEach(row => {
        const quantiteInput = row.querySelector('.quantity-input');
        if (quantiteInput) {
            const prixUnitaireText = row.querySelector('td:nth-child(4)').textContent.replace(/[^\d,]/g, '').replace(',', '');
            const prixUnitaire = parseFloat(prixUnitaireText) || 0;
            const quantite = parseFloat(quantiteInput.value) || 0;
            const total = quantite * prixUnitaire;
            totalGlobal += total;
        }
    });
    
    // Mettre à jour le champ prix total global
    const prixTotalGlobal = document.getElementById('prix_total_global');
    if (prixTotalGlobal) {
        prixTotalGlobal.value = totalGlobal.toFixed(2);
        
        // Mettre à jour l'affichage du total global si présent
        const totalGlobalDisplay = document.getElementById('total-global-display');
        if (totalGlobalDisplay) {
            totalGlobalDisplay.textContent = Number(totalGlobal).toLocaleString('fr-FR') + ' FCFA';
        }
    }
}

// Fonction pour supprimer une commande
function deleteCommande(commandeId, designation) {
    if (confirm(`Êtes-vous sûr de vouloir supprimer l'article "${designation}" de cette commande ?`)) {
        // Ajouter un champ caché pour marquer la commande comme supprimée
        const form = document.getElementById('commande-form');
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'commande_supprimee';
        hiddenInput.value = commandeId;
        form.appendChild(hiddenInput);
        
        // Supprimer la ligne du tableau
        const row = document.querySelector(`tr[data-commande-id="${commandeId}"]`);
        if (row) {
            row.remove();
            updateTotalGlobal();
        }
        
        // Vérifier s'il reste des lignes
        const remainingRows = document.querySelectorAll('#articles-table tbody tr:not(.no-articles-row)');
        if (remainingRows.length === 0) {
            const tbody = document.querySelector('#articles-table tbody');
            tbody.innerHTML = `
                <tr class="no-articles-row">
                    <td colspan="6" class="no-articles-message">
                        <i class="fas fa-info-circle"></i>
                        <p>Aucun article dans cette commande.</p>
                    </td>
                </tr>
            `;
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Calculer le total global initial
    updateTotalGlobal();
    
    // Réutilisation du même système que la création
    let searchTimeout;
    const searchInput = document.getElementById('article_search');

    function normalizeDecimalInput(value) {
        if (value === null || value === undefined) return 0;
        let valueStr = String(value).trim();
        valueStr = valueStr.replace(',', '.');
        valueStr = valueStr.replace(/[^\d.-]/g, '');
        valueStr = valueStr.replace(/\s/g, '');
        if (!valueStr || valueStr === '-' || valueStr === '.') return 0;
        const parts = valueStr.split('.');
        if (parts.length > 2) {
            valueStr = parts[0] + '.' + parts.slice(1).join('');
        }
        const result = parseFloat(valueStr);
        return isNaN(result) ? 0 : result;
    }

    function searchArticles() {
        const searchTerm = document.getElementById('article_search').value.trim();
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (searchTerm.length >= 1) {
                const url = `{% url 'rechercher_articles_commande' %}?search_term=${encodeURIComponent(searchTerm)}`;
                fetch(url, { headers: { 'Accept': 'application/json' } })
                    .then(async (response) => {
                        const contentType = response.headers.get('content-type') || '';
                        if (!response.ok) {
                            return { success: false, articles: [] };
                        }
                        if (contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            return { success: false, articles: [] };
                        }
                    })
                    .then(data => {
                        const list = (data && data.success && Array.isArray(data.articles)) ? data.articles : [];
                        showSearchResults(list);
                    })
                    .catch((e) => {
                        console.error('[SEARCH] Fetch error', e);
                        showSearchResults([]);
                    });
            } else {
                hideSearchResults();
            }
        }, 300);
    }
    // Rendre accessible au onkeyup inline
    window.searchArticles = searchArticles;

    function showSearchResults(articles) {
        const input = document.getElementById('article_search');
        let box = document.getElementById('search_results');
        if (input && input.parentNode) {
            input.parentNode.style.position = 'relative';
        }
        if (!box) {
            box = document.createElement('div');
            box.id = 'search_results';
            box.className = 'search-results';
            if (input && input.parentNode) {
                input.parentNode.appendChild(box);
            }
        } else {
            if (box.parentNode !== input.parentNode && input && input.parentNode) {
                input.parentNode.appendChild(box);
            }
        }
        box.innerHTML = '';
        if (!articles.length) {
            box.innerHTML = '<div class="search-result-item">Aucun article trouvé</div>';
        } else {
            articles.forEach(a => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <div class="search-result-name">${a.reference || ''} - ${a.designation}</div>
                    <div class="search-result-details">Prix: ${Number(a.prix_vente || 0).toLocaleString()} FCFA | Stock: ${a.stock || 0}</div>
                `;
                item.onclick = () => addArticleToTable(a.id, a.designation, a.prix_vente || 0, a.stock || 0, a.reference || '');
                box.appendChild(item);
            });
        }
        box.style.display = 'block';
        box.style.zIndex = '1000';
    }

    // Masquer le dropdown quand on clique ailleurs
    document.addEventListener('click', function(e) {
        const input = document.getElementById('article_search');
        const box = document.getElementById('search_results');
        if (box && !e.target.closest('#article_search') && !e.target.closest('#search_results')) {
            box.style.display = 'none';
        }
    });

    function hideSearchResults() {
        const box = document.getElementById('search_results');
        if (box) box.style.display = 'none';
    }

    function addArticleToTable(articleId, designation, prixVente, stock, reference = '') {
        let tbody = document.querySelector('#articles-table tbody');
        if (!tbody) return;
        
        // Supprimer le message "aucun article" s'il existe
        const noArticlesRow = tbody.querySelector('.no-articles-row');
        if (noArticlesRow) {
            noArticlesRow.remove();
        }
        
        const existing = tbody.querySelector(`tr[data-article-id="${articleId}"]`);
        if (existing) {
            const quantiteInput = existing.querySelector('.quantity-input');
            const current = normalizeDecimalInput(quantiteInput.value) || 1;
            quantiteInput.value = current + 1;
            updateRowTotal(existing);
            updateTotalGlobal();
            hideSearchResults();
            return;
        }
        const row = document.createElement('tr');
        row.setAttribute('data-article-id', articleId);
        row.innerHTML = `
            <td>${designation}</td>
            <td>${reference || '-'}</td>
            <td><input type="number" class="quantity-input" value="1" min="0" step="0.001" onchange="updateRowTotal(this.closest('tr'))" oninput="updateRowTotal(this.closest('tr'))"></td>
            <td>${Number(prixVente).toLocaleString()} FCFA</td>
            <td class="total-cell">${Number(prixVente).toLocaleString()} FCFA</td>
            <td><button type="button" class="btn-delete-line" title="Retirer" onclick="removeArticleRow(this.closest('tr'))"><i class="fas fa-trash"></i></button></td>
        `;
        tbody.appendChild(row);
        updateRowTotal(row);
        updateTotalGlobal();
        hideSearchResults();
        document.getElementById('article_search').value = '';
    }

    function removeArticleRow(row) {
        if (confirm('Êtes-vous sûr de vouloir retirer cet article ?')) {
            row.remove();
            updateTotalGlobal();
            
            // Vérifier s'il reste des lignes
            const remainingRows = document.querySelectorAll('#articles-table tbody tr:not(.no-articles-row)');
            if (remainingRows.length === 0) {
                const tbody = document.querySelector('#articles-table tbody');
                tbody.innerHTML = `
                    <tr class="no-articles-row">
                        <td colspan="6" class="no-articles-message">
                            <i class="fas fa-info-circle"></i>
                            <p>Aucun article dans cette commande.</p>
                        </td>
                    </tr>
                `;
            }
        }
    }
    window.removeArticleRow = removeArticleRow;

    // Validation du formulaire
    const form = document.getElementById('commande-form');
    
    form.addEventListener('submit', function(e) {
        const date = document.getElementById('date').value;
        const heure = document.getElementById('heure').value;
        const etatCommande = document.getElementById('etat_commande').value;
        const prixTotalGlobal = document.getElementById('prix_total_global').value;

        if (!date) {
            e.preventDefault();
            alert('La date est obligatoire.');
            return false;
        }

        if (!heure) {
            e.preventDefault();
            alert('L\'heure est obligatoire.');
            return false;
        }

        if (!etatCommande) {
            e.preventDefault();
            alert('L\'état de la commande est obligatoire.');
            return false;
        }

        // Vérifier qu'il reste au moins un article
        const remainingRows = document.querySelectorAll('#articles-table tbody tr[data-commande-id], #articles-table tbody tr[data-article-id]');
        if (remainingRows.length === 0) {
            e.preventDefault();
            alert('La commande doit contenir au moins un article.');
            return false;
        }

        // Compiler les nouvelles lignes (avec data-article-id) -> articles_data JSON
        const rows = document.querySelectorAll('#articles-table tbody tr[data-article-id]:not([data-commande-id])');
        const items = [];
        rows.forEach(row => {
            const id = row.getAttribute('data-article-id');
            const q = row.querySelector('.quantity-input')?.value || '0';
            const prixUnitaireText = row.querySelector('td:nth-child(4)').textContent.replace(/[^\d,]/g, '').replace(',', '');
            const p = parseFloat(prixUnitaireText) || 0;
            if (id) items.push({ id: id, quantite: q, prix_vente: p });
        });
        if (items.length > 0) {
            document.getElementById('articles_data').value = JSON.stringify(items);
        }

        // Confirmation avant soumission
        if (!confirm('Êtes-vous sûr de vouloir enregistrer les modifications de cette commande ?')) {
            e.preventDefault();
            return false;
        }
    });

    // Validation en temps réel des inputs
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (value < 0) {
                this.value = 0;
            }
        });
    });
});
</script>
</body>
</html>
