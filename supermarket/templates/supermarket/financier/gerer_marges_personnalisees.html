{% extends 'supermarket/financier/dashboard_financier.html' %}

{% block content %}
<div class="content">
    <h2><i class="fas fa-sliders-h" style="color: #f5576c; margin-right: 10px;"></i>Gérer les Marges Personnalisées</h2>
    
    <style>
        .section-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .section-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 700;
            border-bottom: 2px solid #f5576c;
            padding-bottom: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .marges-list {
            display: grid;
            gap: 15px;
        }
        .marge-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .marge-info {
            flex: 1;
        }
        .marge-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #2c3e50;
        }
        .marge-range {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .marge-actions {
            display: flex;
            gap: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1em;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #f5576c;
        }
        .assignations-list {
            margin-top: 20px;
        }
        .assignation-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-content::-webkit-scrollbar {
            width: 10px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close:hover {
            color: #000;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #liste_articles_selectionnes::-webkit-scrollbar {
            width: 8px;
        }
        #liste_articles_selectionnes::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #liste_articles_selectionnes::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #liste_articles_selectionnes::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #article_id {
            border: 2px solid #e1e8ed;
        }
        #article_id:focus {
            border-color: #f5576c;
            outline: none;
        }
    </style>
    
    <div id="alertContainer"></div>
    
    <!-- Section 1: Liste des marges personnalisées -->
    <div class="section-card">
        <h3 class="section-title">
            <i class="fas fa-tags"></i> Marges Personnalisées
            <button class="btn btn-primary" onclick="ouvrirModalMarge()" style="float: right;">
                <i class="fas fa-plus"></i> Créer une Marge
            </button>
        </h3>
        
        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
            <strong><i class="fas fa-info-circle"></i> Comment ça fonctionne :</strong>
            <ul style="margin: 10px 0 0 20px; color: #555;">
                <li>Les marges définissent les <strong>seuils pour la classification automatique</strong></li>
                <li>Les <strong>assignations manuelles ont toujours priorité</strong> sur le calcul automatique</li>
                <li><strong>Exemple :</strong> Si vous créez "Bonne Marge" avec 7%, les articles NON assignés manuellement avec ≥7% iront automatiquement dans cette catégorie</li>
                <li><strong>Mais :</strong> Si vous assignez manuellement le riz à "Bonne Marge" et l'huile à "Mauvaise Marge", ils iront dans leurs catégories respectives <strong>peu importe leur pourcentage de marge</strong></li>
            </ul>
        </div>
        
        <div class="marges-list">
            {% for marge in marges %}
            <div class="marge-item" style="border-left-color: {{ marge.couleur }};">
                <div class="marge-info">
                    <div class="marge-name">{{ marge.nom_categorie }}</div>
                    <div class="marge-range">
                        {% if marge.marge_max %}
                            {{ marge.marge_min }}% à {{ marge.marge_max }}% (classification automatique)
                        {% else %}
                            ≥ {{ marge.marge_min }}% (classification automatique)
                        {% endif %}
                        | Ordre: {{ marge.ordre }}
                        | {% if marge.actif %}<span style="color: #28a745;">Actif</span>{% else %}<span style="color: #dc3545;">Inactif</span>{% endif %}
                    </div>
                </div>
                <div class="marge-actions">
                    <button class="btn btn-secondary" onclick="modifierMarge({{ marge.id }}, '{{ marge.nom_categorie }}', {{ marge.marge_min }}, {% if marge.marge_max %}{{ marge.marge_max }}{% else %}null{% endif %}, '{{ marge.couleur }}', {{ marge.ordre }}, {{ marge.actif|lower }})">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    <button class="btn btn-danger" onclick="supprimerMarge({{ marge.id }})">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
            {% empty %}
            <p style="color: #6c757d; text-align: center; padding: 20px;">
                Aucune marge personnalisée. Les marges par défaut seront utilisées (Bonne ≥10%, Médiocre 4-9%, Faible <4%).
            </p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Section 2: Assignations manuelles d'articles -->
    <div class="section-card">
        <h3 class="section-title">
            <i class="fas fa-link"></i> Assignations Manuelles d'Articles
            <button class="btn btn-primary" onclick="ouvrirModalAssignation()" style="float: right;">
                <i class="fas fa-plus"></i> Assigner des Articles
            </button>
        </h3>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <strong><i class="fas fa-exclamation-triangle"></i> Priorité absolue :</strong>
            <p style="margin: 10px 0 0 0; color: #555;">
                Les articles assignés manuellement iront <strong>TOUJOURS</strong> dans leur catégorie assignée, 
                <strong>peu importe leur pourcentage de marge calculé</strong>.
                <br><strong>Exemple :</strong> Le riz à 7% peut être assigné à "Bonne Marge" et l'huile à 7% peut être assignée à "Mauvaise Marge".
            </p>
        </div>
        
        <div class="assignations-list">
            {% for assignation in assignations %}
            <div class="assignation-item" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                <div>
                    <strong>{{ assignation.article.reference_article }}</strong> - {{ assignation.article.designation }}
                    <br>
                    <small style="color: #856404;">
                        <i class="fas fa-hand-point-right"></i> Assigné manuellement à <strong>{{ assignation.marge_personnalisee.nom_categorie }}</strong>
                        <br>
                        <i class="fas fa-info-circle"></i> Cette assignation a priorité sur le calcul automatique
                    </small>
                </div>
                <button class="btn btn-danger" onclick="retirerAssignation({{ assignation.id }})">
                    <i class="fas fa-times"></i> Retirer
                </button>
            </div>
            {% empty %}
            <p style="color: #6c757d; text-align: center; padding: 20px;">
                Aucune assignation manuelle. Les articles seront classés automatiquement selon les marges définies.
            </p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Modal pour créer/modifier une marge -->
    <div id="modalMarge" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fermerModalMarge()">&times;</span>
            <h3 id="modalMargeTitle">Créer une Marge Personnalisée</h3>
            <form id="formMarge" onsubmit="enregistrerMarge(event)">
                <input type="hidden" id="marge_id_form" name="marge_id">
                <div class="form-group">
                    <label>Nom de la catégorie *</label>
                    <input type="text" id="nom_categorie" name="nom_categorie" required placeholder="Ex: Marge Excellente">
                </div>
                <div class="form-group">
                    <label>Marge minimale (%) *</label>
                    <input type="number" id="marge_min" name="marge_min" step="0.01" min="0" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Marge maximale (%) - Laisser vide pour "≥ min"</label>
                    <input type="number" id="marge_max" name="marge_max" step="0.01" min="0" placeholder="Optionnel">
                </div>
                <div class="form-group">
                    <label>Couleur d'affichage</label>
                    <input type="color" id="couleur" name="couleur" value="#28a745">
                </div>
                <div class="form-group">
                    <label>Ordre d'affichage</label>
                    <input type="number" id="ordre" name="ordre" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="actif" name="actif" checked> Actif
                    </label>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="fermerModalMarge()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal pour assigner un article -->
    <div id="modalAssignation" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fermerModalAssignation()">&times;</span>
            <h3>Assigner des Articles à une Catégorie</h3>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong><i class="fas fa-exclamation-triangle"></i> Assignation manuelle = Priorité absolue</strong>
                <p style="margin: 10px 0 0 0; color: #555;">
                    Les articles assignés manuellement iront <strong>TOUJOURS</strong> dans la catégorie choisie, 
                    <strong>peu importe leur pourcentage de marge calculé</strong>.
                    <br><br>
                    <strong>Exemple concret :</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>Le <strong>riz à 7%</strong> → assignez-le à "Bonne Marge"</li>
                        <li>L'<strong>huile à 7%</strong> → assignez-la à "Mauvaise Marge"</li>
                    </ul>
                    Ils iront dans leurs catégories respectives même s'ils ont le même pourcentage !
                </p>
            </div>
            <form id="formAssignation" onsubmit="enregistrerAssignation(event)">
                <div class="form-group">
                    <label>Rechercher et sélectionner des articles *</label>
                    <input type="text" id="recherche_article" placeholder="Rechercher un article..." style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px; margin-bottom: 10px;" onkeyup="filtrerArticles()">
                    <select id="article_id" name="article_id" multiple required size="6" style="height: 150px; width: 100%; max-height: 150px;">
                        {% for article in articles %}
                        <option value="{{ article.id }}" data-ref="{{ article.reference_article }}" data-designation="{{ article.designation }}">
                            {{ article.reference_article }} - {{ article.designation }}
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> <strong>Comment sélectionner :</strong> 
                        Cliquez sur un article pour le sélectionner. 
                        Maintenez <strong>Ctrl</strong> (Windows) ou <strong>Cmd</strong> (Mac) et cliquez pour sélectionner plusieurs articles.
                        Les articles sélectionnés apparaîtront ci-dessous.
                    </small>
                </div>
                
                <!-- Liste des articles sélectionnés -->
                <div class="form-group" id="articles_selectionnes_container" style="display: none; margin-top: 20px;">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 10px; display: block;">
                        <i class="fas fa-check-circle" style="color: #28a745;"></i> Articles sélectionnés (<span id="nombre_articles_selectionnes">0</span>)
                    </label>
                    <div id="liste_articles_selectionnes" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto; border: 2px solid #28a745; min-height: 50px;">
                        <!-- Les articles sélectionnés apparaîtront ici -->
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 10px; display: block;">
                        <i class="fas fa-tag"></i> Catégorie de marge *
                    </label>
                    <select id="marge_id" name="marge_id" required style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 1em; background: white; cursor: pointer;">
                        <option value="">-- Sélectionner une catégorie --</option>
                        {% for marge in marges %}
                        <option value="{{ marge.id }}">{{ marge.nom_categorie }}</option>
                        {% endfor %}
                    </select>
                    {% if not marges %}
                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107;">
                        <small style="color: #856404;">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Aucune marge personnalisée créée.</strong> Veuillez d'abord créer une marge personnalisée avant d'assigner des articles.
                        </small>
                    </div>
                    {% else %}
                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> Choisissez la catégorie dans laquelle les articles sélectionnés seront classés.
                    </small>
                    {% endif %}
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="fermerModalAssignation()">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="btnAssignerArticles" disabled>
                        <i class="fas fa-check"></i> Assigner <span id="btn_nombre_articles">0</span> article(s)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Gestion des modals
function ouvrirModalMarge() {
    document.getElementById('modalMarge').style.display = 'block';
    document.getElementById('marge_id_form').value = '';
    document.getElementById('formMarge').reset();
    document.getElementById('modalMargeTitle').textContent = 'Créer une Marge Personnalisée';
    document.getElementById('couleur').value = '#28a745';
    document.getElementById('actif').checked = true;
}

function fermerModalMarge() {
    document.getElementById('modalMarge').style.display = 'none';
}

function modifierMarge(id, nom, min, max, couleur, ordre, actif) {
    document.getElementById('modalMarge').style.display = 'block';
    document.getElementById('marge_id_form').value = id;
    document.getElementById('nom_categorie').value = nom;
    document.getElementById('marge_min').value = min;
    document.getElementById('marge_max').value = max || '';
    document.getElementById('couleur').value = couleur;
    document.getElementById('ordre').value = ordre;
    document.getElementById('actif').checked = actif;
    document.getElementById('modalMargeTitle').textContent = 'Modifier une Marge Personnalisée';
}

function ouvrirModalAssignation() {
    const modal = document.getElementById('modalAssignation');
    if (!modal) {
        console.error('Modal non trouvé');
        return;
    }
    
    modal.style.display = 'block';
    document.getElementById('formAssignation').reset();
    document.getElementById('articles_selectionnes_container').style.display = 'none';
    document.getElementById('liste_articles_selectionnes').innerHTML = '';
    document.getElementById('nombre_articles_selectionnes').textContent = '0';
    const btnNombre = document.getElementById('btn_nombre_articles');
    if (btnNombre) {
        btnNombre.textContent = '0';
    }
    document.getElementById('btnAssignerArticles').disabled = true;
    document.getElementById('recherche_article').value = '';
    
    // Réinitialiser toutes les options visibles et désélectionner
    const select = document.getElementById('article_id');
    if (!select) {
        console.error('Select article_id non trouvé');
        return;
    }
    
    Array.from(select.options).forEach(option => {
        option.style.display = '';
        option.selected = false;
    });
    
    // Attacher UNIQUEMENT l'événement change pour éviter les boucles
    select.onchange = function() {
        mettreAJourArticlesSelectionnes();
    };
    
    // S'assurer que le select de catégorie est visible et fonctionnel
    const selectMarge = document.getElementById('marge_id');
    if (selectMarge) {
        selectMarge.style.display = 'block';
        selectMarge.style.visibility = 'visible';
        selectMarge.disabled = false;
        selectMarge.style.opacity = '1';
        console.log('Select de catégorie trouvé et activé');
    } else {
        console.error('Select marge_id non trouvé dans le modal');
    }
    
    // Forcer une mise à jour initiale
    setTimeout(mettreAJourArticlesSelectionnes, 100);
}

function fermerModalAssignation() {
    document.getElementById('modalAssignation').style.display = 'none';
    const select = document.getElementById('article_id');
    select.removeEventListener('change', mettreAJourArticlesSelectionnes);
}

// Filtrer les articles selon la recherche
function filtrerArticles() {
    const recherche = document.getElementById('recherche_article').value.toLowerCase();
    const select = document.getElementById('article_id');
    
    Array.from(select.options).forEach(option => {
        const texte = option.textContent.toLowerCase();
        if (texte.includes(recherche)) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    });
}

// Variable pour éviter les appels multiples
let isUpdating = false;

// Mettre à jour la liste des articles sélectionnés
function mettreAJourArticlesSelectionnes() {
    // Éviter les appels multiples simultanés
    if (isUpdating) return;
    isUpdating = true;
    
    const select = document.getElementById('article_id');
    if (!select) {
        console.error('Select article_id non trouvé');
        isUpdating = false;
        return;
    }
    
    const selectedOptions = Array.from(select.selectedOptions);
    console.log('Articles sélectionnés:', selectedOptions.length);
    
    const container = document.getElementById('articles_selectionnes_container');
    const liste = document.getElementById('liste_articles_selectionnes');
    const nombre = document.getElementById('nombre_articles_selectionnes');
    const btnAssigner = document.getElementById('btnAssignerArticles');
    
    if (!container) {
        console.error('Container articles_selectionnes_container non trouvé');
        isUpdating = false;
        return;
    }
    if (!liste) {
        console.error('Liste liste_articles_selectionnes non trouvée');
        isUpdating = false;
        return;
    }
    if (!nombre) {
        console.error('Nombre nombre_articles_selectionnes non trouvé');
        isUpdating = false;
        return;
    }
    if (!btnAssigner) {
        console.error('Bouton btnAssignerArticles non trouvé');
        isUpdating = false;
        return;
    }
    
    const nombreArticles = selectedOptions.length;
    nombre.textContent = nombreArticles;
    
    // Mettre à jour le bouton
    const btnNombre = document.getElementById('btn_nombre_articles');
    if (btnNombre) {
        btnNombre.textContent = nombreArticles;
    }
    
    if (nombreArticles > 0) {
        container.style.display = 'block';
        container.style.visibility = 'visible';
        container.style.opacity = '1';
        liste.innerHTML = '';
        
        selectedOptions.forEach(option => {
            const ref = option.getAttribute('data-ref') || option.textContent.split(' - ')[0];
            const designation = option.getAttribute('data-designation') || option.textContent.split(' - ')[1] || '';
            const div = document.createElement('div');
            div.style.cssText = 'padding: 8px; margin: 5px 0; background: white; border-radius: 5px; border-left: 3px solid #f5576c; display: flex; justify-content: space-between; align-items: center;';
            div.innerHTML = `
                <span><strong>${ref}</strong> - ${designation}</span>
                <button type="button" onclick="deselectionnerArticle('${option.value}')" style="background: #dc3545; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            liste.appendChild(div);
        });
        
        btnAssigner.disabled = false;
        console.log('Liste des articles affichée');
    } else {
        container.style.display = 'none';
        btnAssigner.disabled = true;
        if (btnNombre) {
            btnNombre.textContent = '0';
        }
    }
    
    isUpdating = false;
}

// Désélectionner un article
function deselectionnerArticle(articleId) {
    const select = document.getElementById('article_id');
    const option = Array.from(select.options).find(opt => opt.value === articleId);
    if (option) {
        option.selected = false;
        mettreAJourArticlesSelectionnes();
    }
}

// Enregistrer une marge
function enregistrerMarge(event) {
    event.preventDefault();
    
    const formData = new FormData();
    const margeId = document.getElementById('marge_id_form').value;
    
    formData.append('nom_categorie', document.getElementById('nom_categorie').value);
    formData.append('marge_min', document.getElementById('marge_min').value);
    formData.append('marge_max', document.getElementById('marge_max').value);
    formData.append('couleur', document.getElementById('couleur').value);
    formData.append('ordre', document.getElementById('ordre').value);
    formData.append('actif', document.getElementById('actif').checked);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    const url = margeId 
        ? '{% url "modifier_marge_personnalisee" 0 %}'.replace('0', margeId)
        : '{% url "creer_marge_personnalisee" %}';
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Marge enregistrée avec succès', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Erreur: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Erreur lors de l\'enregistrement', 'error');
        console.error(error);
    });
}

// Supprimer une marge
function supprimerMarge(id) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer cette marge ?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "supprimer_marge_personnalisee" 0 %}'.replace('0', id), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Marge supprimée avec succès', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Erreur: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Erreur lors de la suppression', 'error');
        console.error(error);
    });
}

// Enregistrer une assignation (plusieurs articles à la fois)
function enregistrerAssignation(event) {
    event.preventDefault();
    
    const articleSelect = document.getElementById('article_id');
    const selectedArticles = Array.from(articleSelect.selectedOptions).map(option => option.value);
    const margeId = document.getElementById('marge_id').value;
    
    if (selectedArticles.length === 0) {
        showAlert('Veuillez sélectionner au moins un article', 'error');
        return;
    }
    
    if (!margeId) {
        showAlert('Veuillez sélectionner une catégorie de marge', 'error');
        return;
    }
    
    // Créer le FormData avec tous les articles en une seule requête
    const formData = new FormData();
    selectedArticles.forEach(articleId => {
        formData.append('article_id', articleId);
    });
    formData.append('marge_id', margeId);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "assigner_article_marge" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const total = data.created_count + data.updated_count;
            let message = `${total} article(s) assigné(s) à "${data.marge_nom}"`;
            if (data.created_count > 0 && data.updated_count > 0) {
                message += ` (${data.created_count} créé(s), ${data.updated_count} mis à jour)`;
            }
            if (data.errors && data.errors.length > 0) {
                message += `. ${data.errors.length} erreur(s): ${data.errors.join(', ')}`;
            }
            showAlert(message, data.errors && data.errors.length > 0 ? 'error' : 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Erreur: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Erreur lors de l\'assignation', 'error');
        console.error(error);
    });
}

// Retirer une assignation
function retirerAssignation(id) {
    if (!confirm('Retirer l\'assignation manuelle de cet article ?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "retirer_assignation_article" 0 %}'.replace('0', id), {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Assignation retirée avec succès', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Erreur: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Erreur lors de la suppression', 'error');
        console.error(error);
    });
}

function showAlert(message, type) {
    const container = document.getElementById('alertContainer');
    container.innerHTML = `<div class="alert alert-${type}">
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
    </div>`;
    setTimeout(() => {
        container.innerHTML = '';
    }, 5000);
}

// Attacher l'événement au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const select = document.getElementById('article_id');
    if (select) {
        // Attacher UNIQUEMENT l'événement change
        select.onchange = function() {
            mettreAJourArticlesSelectionnes();
        };
    }
});

// Fermer les modals en cliquant en dehors
window.onclick = function(event) {
    const modalMarge = document.getElementById('modalMarge');
    const modalAssignation = document.getElementById('modalAssignation');
    if (event.target == modalMarge) {
        fermerModalMarge();
    }
    if (event.target == modalAssignation) {
        fermerModalAssignation();
    }
}
</script>
{% endblock %}
