{% extends 'supermarket/stock/base_stock.html' %}
{% load static %}

{% block title %}Mouvements de Stock{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
    }

    .container-fluid {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
    display: flex;
        justify-content: space-between;
    align-items: center;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .header-content h1 {
    margin: 0;
        font-size: 2.2em;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

    .header-content p {
        margin: 10px 0 0 0;
    opacity: 0.9;
        font-size: 1.1em;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.2);
    color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
    }

    .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #6610f2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
    }

    .btn-info:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
    }

    .btn-warning:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-danger:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-success:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
    display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: white;
    }

    .stat-card:nth-child(1) .stat-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card:nth-child(2) .stat-icon {
        background: linear-gradient(135deg, #17a2b8 0%, #6610f2 100%);
    }

    .stat-card:nth-child(3) .stat-icon {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .stat-card:nth-child(4) .stat-icon {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
    }

    .stat-number {
        font-size: 2em;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
        font-weight: 500;
    }

    .card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
        overflow: hidden;
        margin-bottom: 25px;
    }

    .card-header {
        background: #f8f9fa;
        padding: 20px 25px;
        border-bottom: 1px solid #e9ecef;
    }

    .card-header h5 {
        margin: 0;
        color: #495057;
        font-size: 1.3em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-body {
        padding: 25px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
        font-size: 0.9em;
    }

    .form-control {
        padding: 12px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 0.95em;
        transition: all 0.3s ease;
        background: white;
        font-family: inherit;
        width: 100%;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-block {
        width: 100%;
    }

    .loading-spinner {
        text-align: center;
        padding: 40px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        margin: 20px 0;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
    }

    .export-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 25px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .table th {
        background: #f8f9fa;
        color: #495057;
        font-weight: 600;
        padding: 15px 12px;
        text-align: left;
        border-bottom: 2px solid #e9ecef;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table th i {
        margin-right: 6px;
        color: #667eea;
    }

    /* Styles pour la s√©lection multiple d'articles */
    .article-selection-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        border: 1px solid #e9ecef;
    }

    .search-box {
        margin-bottom: 15px;
    }

    .article-item label:hover {
        background-color: rgba(102, 126, 234, 0.1);
    }

    .article-item input[type="checkbox"]:checked + span {
        color: #667eea;
        font-weight: 600;
    }

    .article-item input[type="checkbox"]:checked + span strong {
        color: #667eea;
    }

    .selection-info {
        background: white;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .table td {
        padding: 12px;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
        font-size: 0.9em;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
    }

    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        border: 1px solid transparent;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-info {
        background: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    .alert-success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-warning {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    .alert-danger {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-entree {
        background: #d4edda;
        color: #155724;
    }

    .badge-sortie {
        background: #f8d7da;
        color: #721c24;
    }

    .badge-ajustement {
        background: #fff3cd;
        color: #856404;
    }

    .badge-inventaire {
        background: #d1ecf1;
        color: #0c5460;
    }

    .badge-transfert {
        background: #e2e3e5;
        color: #383d41;
    }

    .badge-perte {
        background: #f5c6cb;
        color: #721c24;
    }

    .badge-retour {
        background: #cce5ff;
        color: #004085;
    }

    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            text-align: center;
            gap: 20px;
        }

        .header-actions {
            justify-content: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .export-actions {
            flex-direction: column;
        }

        .table-responsive {
            font-size: 0.8em;
        }

        .table th,
        .table td {
            padding: 8px 6px;
        }
    }
    
    /* Styles pour les boutons de mode de s√©lection */
    .selection-mode-container .btn-group {
        display: flex;
        width: 100%;
    }
    
    .selection-mode-container .btn-check {
        position: absolute;
        clip: rect(0, 0, 0, 0);
        pointer-events: none;
    }
    
    .selection-mode-container .btn-outline-primary {
        flex: 1;
        border: 2px solid #007bff;
        color: #007bff;
        background: white;
        padding: 10px 15px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .selection-mode-container .btn-outline-primary:hover {
        background: #007bff;
        color: white;
        transform: translateY(-1px);
    }
    
    .selection-mode-container .btn-check:checked + .btn-outline-primary {
        background: #007bff;
        color: white;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }
    
    .selection-mode-container .btn-outline-primary:first-child {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .selection-mode-container .btn-outline-primary:last-child {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    
    .range-info {
        transition: all 0.3s ease;
    }
    
    .range-info.show {
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Styles pour le tableau Excel - Structure visuelle uniquement */
    .excel-style-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .excel-header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
    }
    
    .excel-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .excel-period {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
    }
    
    .excel-company {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-weight: bold;
    }
    
    .company-name {
        font-size: 16px;
        color: #333;
    }
    
    .company-location {
        font-size: 14px;
        color: #666;
    }
    
    .excel-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-size: 12px;
        color: #666;
    }
    
    .excel-table-container {
        border: 1px solid #333;
        border-radius: 4px;
        overflow: hidden;
        background: white;
    }
    
    .excel-table {
        margin-bottom: 0;
        font-size: 11px;
        border-collapse: collapse;
        width: 100%;
    }
    
    .excel-thead {
        background-color: #f0f0f0;
    }
    
    .excel-header-row {
        background-color: #e0e0e0;
        font-weight: bold;
        border-bottom: 2px solid #333;
    }
    
    .excel-subheader-row {
        background-color: #f5f5f5;
        font-size: 10px;
        border-bottom: 1px solid #ccc;
    }
    
    .excel-th {
        border: 1px solid #999;
        padding: 4px 2px;
        text-align: center;
        font-weight: bold;
        background-color: #f0f0f0;
        white-space: nowrap;
        font-size: 10px;
    }
    
    .excel-tbody td {
        border: 1px solid #999;
        padding: 3px 2px;
        text-align: center;
        font-size: 10px;
        background: white;
    }
    
    .excel-tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .excel-tbody tr:hover {
        background-color: #e3f2fd;
    }
    
    .excel-footer {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #333;
        font-weight: bold;
        background: #f0f0f0;
        padding: 10px;
        border-radius: 4px;
    }
    
    .footer-left {
        font-size: 12px;
        color: #333;
    }
    
    .footer-right {
        font-size: 12px;
        color: #333;
        font-weight: bold;
    }
    
    /* Largeurs des colonnes pour ressembler √† Excel */
    .excel-table td:nth-child(1) { width: 70px; } /* Date */
    .excel-table td:nth-child(2) { width: 50px; } /* Type */
    .excel-table td:nth-child(3) { width: 20px; } /* Vide */
    .excel-table td:nth-child(4) { width: 40px; } /* N¬∞ */
    .excel-table td:nth-child(5) { width: 20px; } /* Vide */
    .excel-table td:nth-child(6) { width: 20px; } /* Vide */
    .excel-table td:nth-child(7) { width: 20px; } /* Vide */
    .excel-table td:nth-child(8) { width: 80px; } /* R√©f√©rence */
    .excel-table td:nth-child(9) { width: 20px; } /* Vide */
    .excel-table td:nth-child(10) { width: 20px; } /* Vide */
    .excel-table td:nth-child(11) { width: 20px; } /* Vide */
    .excel-table td:nth-child(12) { width: 50px; } /* +/- */
    .excel-table td:nth-child(13) { width: 70px; } /* Quantit√©s */
    .excel-table td:nth-child(14) { width: 50px; } /* Solde */
    .excel-table td:nth-child(15) { width: 70px; } /* C.M.U.P. */
    .excel-table td:nth-child(16) { width: 50px; } /* unitaire */
    .excel-table td:nth-child(17) { width: 20px; } /* Vide */
    .excel-table td:nth-child(18) { width: 80px; } /* Stock permanent */
    
    /* Alignement des nombres */
    .excel-table td:nth-child(12),
    .excel-table td:nth-child(13),
    .excel-table td:nth-child(14),
    .excel-table td:nth-child(15),
    .excel-table td:nth-child(18) {
        text-align: right;
    }
    
    /* Couleurs pour les types de mouvement */
    .mouvement-entree {
        color: #28a745;
        font-weight: bold;
    }
    
    .mouvement-sortie {
        color: #dc3545;
        font-weight: bold;
    }
    
    .mouvement-report {
        color: #6c757d;
        font-weight: bold;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-t√™te -->
            <div class="page-header">
                <div class="header-content">
                    <h1><i class="fas fa-exchange-alt"></i> Mouvements de Stock</h1>
            <p>Historique des mouvements de stock par article</p>
                </div>
                <div class="header-actions">
                    <a href="{% url 'dashboard_stock' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Retour au Dashboard
                    </a>
        </div>
    </div>

    <!-- Statistiques g√©n√©rales -->
    <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="stat-content">
                <div class="stat-number">{{ total_articles }}</div>
                <div class="stat-label">Articles en Stock</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="stat-content">
                <div class="stat-number">{{ total_mouvements }}</div>
                <div class="stat-label">Mouvements 30j</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="stat-content">
                <div class="stat-number">{{ mouvements_entree }}</div>
                <div class="stat-label">Entr√©es 30j</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div class="stat-content">
                <div class="stat-number">{{ mouvements_sortie }}</div>
                <div class="stat-label">Sorties 30j</div>
            </div>
        </div>
    </div>

    <!-- Formulaire de consultation -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-filter"></i> Crit√®res de Consultation</h5>
                </div>
                <div class="card-body">
            <form id="mouvementsForm" method="POST" action="{% url 'consulter_mouvements_stock' %}">
                        {% csrf_token %}
                        <div class="row">
                    <!-- P√©riode -->
                            <div class="col-md-3">
                                <div class="form-group">
                            <label for="date_debut">Date de D√©but <span style="color: red;">*</span></label>
                                    <input type="date" class="form-control" id="date_debut" name="date_debut" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                            <label for="date_fin">Date de Fin <span style="color: red;">*</span></label>
                                    <input type="date" class="form-control" id="date_fin" name="date_fin" required>
                                </div>
                            </div>
                    
                    <!-- Articles -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Mode de S√©lection <span style="color: red;">*</span></label>
                                    <div class="selection-mode-container" style="margin-bottom: 15px;">
                                        <div class="btn-group" role="group" style="width: 100%;">
                                            <input type="radio" class="btn-check" name="selection_mode" id="mode_individual" value="individual" checked>
                                            <label class="btn btn-outline-primary" for="mode_individual">
                                                <i class="fas fa-list"></i> S√©lection Individuelle
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="selection_mode" id="mode_range" value="range">
                                            <label class="btn btn-outline-primary" for="mode_range">
                                                <i class="fas fa-layer-group"></i> S√©lection par Plage
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Mode S√©lection Individuelle -->
                                    <div id="individual-selection" class="selection-mode">
                                        <label>Articles <span style="color: red;">*</span></label>
                                        <div class="article-selection-container">
                                            <div class="search-box">
                                                <input type="text" id="articleSearch" class="form-control" 
                                                       placeholder="Rechercher un article..." onkeyup="filterArticles()">
                                            </div>
                                            <div class="article-list" id="articleList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 10px;">
                                            {% for article in articles %}
                                                <div class="article-item" data-reference="{{ article.reference_article }}" data-designation="{{ article.designation|lower }}">
                                                    <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; padding: 5px; border-radius: 5px; transition: background-color 0.2s;">
                                                        <input type="checkbox" name="articles" value="{{ article.id }}" style="margin-right: 10px;">
                                                        <span>
                                                            <strong>{{ article.reference_article }}</strong> - {{ article.designation }}
                                                            <small style="color: #666; display: block;">Stock: {{ article.stock_actuel }}</small>
                                                        </span>
                                                    </label>
                                                </div>
                                            {% endfor %}
                                            </div>
                                            <div class="selection-info" id="selectionInfo" style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                                <span id="selectedCount">0 article(s) s√©lectionn√©(s)</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Mode S√©lection par Plage -->
                                    <div id="range-selection" class="selection-mode" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="article_debut">Article de D√©but <span style="color: red;">*</span></label>
                                                <select id="article_debut" name="article_debut" class="form-control">
                                                    <option value="">S√©lectionner l'article de d√©but</option>
                                                    {% for article in articles %}
                                                        <option value="{{ article.id }}" data-designation="{{ article.designation }}">{{ article.designation }} ({{ article.reference_article }})</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="article_fin">Article de Fin <span style="color: red;">*</span></label>
                                                <select id="article_fin" name="article_fin" class="form-control">
                                                    <option value="">S√©lectionner l'article de fin</option>
                                                    {% for article in articles %}
                                                        <option value="{{ article.id }}" data-designation="{{ article.designation }}">{{ article.designation }} ({{ article.reference_article }})</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="range-info" id="range-info" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> 
                                                <span id="range-text">S√©lectionnez les articles de d√©but et de fin</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    
                    <!-- Type de mouvement -->
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="type_mouvement">Type de Mouvement</label>
                                    <select class="form-control" id="type_mouvement" name="type_mouvement">
                                        <option value="">Tous les types</option>
                                        <option value="entree">Entr√©e</option>
                                        <option value="sortie">Sortie</option>
                                        <option value="ajustement">Ajustement</option>
                                        <option value="inventaire">Inventaire</option>
                                        <option value="transfert">Transfert</option>
                                        <option value="perte">Perte</option>
                                        <option value="retour">Retour</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                <!-- Bouton de consultation -->
                <div class="row mt-4">
                            <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-search"></i> Consulter les Mouvements
                                </button>
                            </div>
                        </div>
                    </form>
        </div>
    </div>

    <!-- R√©sultats -->
    <div id="results-section" class="card" style="display: none;">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Fiche de Stock</h5>
                </div>
                <div class="card-body">
                    <div id="mouvements-summary" class="mb-4"></div>
                    
            <div class="export-actions">
                        <a href="{% url 'export_mouvements_excel' %}" class="btn btn-success" target="_blank">
                            <i class="fas fa-file-excel"></i> Exporter en Excel
                        </a>
                        <a href="{% url 'export_mouvements_pdf' %}" class="btn btn-danger" target="_blank">
                            <i class="fas fa-file-pdf"></i> Exporter en PDF
                        </a>
                        <a href="{% url 'export_mouvements_csv' %}" class="btn btn-info" target="_blank">
                            <i class="fas fa-file-csv"></i> Exporter en CSV
                        </a>
                    </div>

                    <!-- Tableau avec structure Excel -->
                    <div class="excel-style-container">
                        <div class="excel-header">
                            <div class="excel-title">Mouvements de stock</div>
                            <div class="excel-period">P√©riode du <span id="date-debut-display"></span> au <span id="date-fin-display"></span></div>
                        </div>
                        
                        <div class="excel-company">
                            <div class="company-name">SUPER MARKET</div>
                            <div class="company-location">MARCHE ESSOS</div>
                        </div>
                        
                        <div class="excel-info">
                            <div class="info-left">
                                <span>Tenue de compte :</span>
                            </div>
                            <div class="info-right">
                                <span>Date de tirage</span>
                                <span id="date-tirage"></span>
                            </div>
                        </div>
                        
                        
                        <div class="table-responsive excel-table-container">
                            <table class="table excel-table" id="mouvements-table">
                                <thead class="excel-thead">
                                    <tr class="excel-header-row">
                                        <th class="excel-th">Date</th>
                                        <th class="excel-th">Type</th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th">N¬∞</th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th">Tiers</th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th">+/-</th>
                                        <th class="excel-th">Quantit√©s en stock</th>
                                        <th class="excel-th">Solde</th>
                                        <th class="excel-th">C.M.U.P.</th>
                                        <th class="excel-th">unitaire</th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th">Stock</th>
                                    </tr>
                                    <tr class="excel-subheader-row">
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th">de</th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th">Tiers</th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th">permanent</th>
                                    </tr>
                                    <tr class="excel-subheader-row">
                                        <th class="excel-th">mouv.</th>
                                        <th class="excel-th">mouv.</th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th">pi√®ce</th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                        <th class="excel-th"></th>
                                    </tr>
                                </thead>
                                <tbody id="mouvements-tbody" class="excel-tbody">
                                    <tr>
                                        <td colspan="18" class="text-center text-muted">
                                            <i class="fas fa-info-circle"></i> S√©lectionnez des crit√®res et cliquez sur "Consulter"
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="excel-footer">
                            <div class="footer-left">
                                <span>Total g√©n√©ral</span>
                            </div>
                            <div class="footer-right">
                                <span id="total-stock-permanent"></span>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div id="messages-container"></div>
</div>

<script>
// Fonction pour filtrer les articles
function filterArticles() {
    const searchTerm = document.getElementById('articleSearch').value.toLowerCase();
    const articleItems = document.querySelectorAll('.article-item');
    
    articleItems.forEach(item => {
        const reference = item.getAttribute('data-reference').toLowerCase();
        const designation = item.getAttribute('data-designation');
        const isVisible = reference.includes(searchTerm) || designation.includes(searchTerm);
        
        item.style.display = isVisible ? 'block' : 'none';
    });
}

// Fonction pour mettre √† jour le compteur de s√©lection
function updateSelectionCount() {
    const selectedCheckboxes = document.querySelectorAll('input[name="articles"]:checked');
    const count = selectedCheckboxes.length;
    document.getElementById('selectedCount').textContent = `${count} article(s) s√©lectionn√©(s)`;
    
    // Changer la couleur selon le nombre s√©lectionn√©
    const selectionInfo = document.getElementById('selectionInfo');
    if (count > 0) {
        selectionInfo.style.backgroundColor = '#e8f5e8';
        selectionInfo.style.borderColor = '#28a745';
    } else {
        selectionInfo.style.backgroundColor = 'white';
        selectionInfo.style.borderColor = '#e9ecef';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les dates
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('date_fin').value = today.toISOString().split('T')[0];
    document.getElementById('date_debut').value = lastMonth.toISOString().split('T')[0];
    
    // Ajouter des √©v√©nements aux checkboxes
    document.querySelectorAll('input[name="articles"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionCount);
    });
    
    // Initialiser le compteur
    updateSelectionCount();
    
    // Gestion des modes de s√©lection
    document.querySelectorAll('input[name="selection_mode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const individualMode = document.getElementById('individual-selection');
            const rangeMode = document.getElementById('range-selection');
            
            if (this.value === 'individual') {
                individualMode.style.display = 'block';
                rangeMode.style.display = 'none';
            } else if (this.value === 'range') {
                individualMode.style.display = 'none';
                rangeMode.style.display = 'block';
            }
        });
    });
    
    // Gestion de la s√©lection par plage
    document.getElementById('article_debut').addEventListener('change', updateRangeSelection);
    document.getElementById('article_fin').addEventListener('change', updateRangeSelection);
    
    function updateRangeSelection() {
        const articleDebut = document.getElementById('article_debut');
        const articleFin = document.getElementById('article_fin');
        const rangeInfo = document.getElementById('range-info');
        const rangeText = document.getElementById('range-text');
        
        if (articleDebut.value && articleFin.value) {
            const debutDesignation = articleDebut.options[articleDebut.selectedIndex].text;
            const finDesignation = articleFin.options[articleFin.selectedIndex].text;
            
            // V√©rifier si l'ordre est correct (d√©but <= fin alphab√©tiquement)
            const debutText = debutDesignation.split(' (')[0];
            const finText = finDesignation.split(' (')[0];
            
            if (debutText <= finText) {
                rangeInfo.style.display = 'block';
                rangeText.innerHTML = `Plage s√©lectionn√©e: <strong>${debutText}</strong> √† <strong>${finText}</strong>`;
                rangeInfo.style.background = '#d4edda';
                rangeInfo.style.border = '1px solid #c3e6cb';
                
                // S√©lectionner automatiquement tous les articles dans la plage
                selectArticlesInRange(articleDebut.value, articleFin.value);
            } else {
                rangeInfo.style.display = 'block';
                rangeText.innerHTML = `‚ö†Ô∏è L'article de d√©but doit √™tre alphab√©tiquement avant l'article de fin`;
                rangeInfo.style.background = '#f8d7da';
                rangeInfo.style.border = '1px solid #f5c6cb';
            }
        } else {
            rangeInfo.style.display = 'none';
        }
    }
    
    function selectArticlesInRange(debutId, finId) {
        // D√©s√©lectionner tous les articles d'abord
        document.querySelectorAll('input[name="articles"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // R√©cup√©rer tous les articles et les trier par d√©signation
        const allArticles = Array.from(document.querySelectorAll('.article-item')).map(item => {
            const checkbox = item.querySelector('input[name="articles"]');
            const designation = item.getAttribute('data-designation');
            return {
                element: item,
                checkbox: checkbox,
                designation: designation,
                id: checkbox.value
            };
        }).sort((a, b) => a.designation.localeCompare(b.designation));
        
        // Trouver les articles de d√©but et fin
        const debutArticle = allArticles.find(article => article.id === debutId);
        const finArticle = allArticles.find(article => article.id === finId);
        
        if (debutArticle && finArticle) {
            const debutIndex = allArticles.indexOf(debutArticle);
            const finIndex = allArticles.indexOf(finArticle);
            
            // S√©lectionner tous les articles dans la plage
            for (let i = debutIndex; i <= finIndex; i++) {
                allArticles[i].checkbox.checked = true;
            }
            
            console.log(`üìä S√©lection automatique: ${finIndex - debutIndex + 1} articles s√©lectionn√©s`);
            updateSelectionCount();
        }
    }
    
    
    // Gestion du formulaire
    document.getElementById('mouvementsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const dateDebut = document.getElementById('date_debut').value;
        const dateFin = document.getElementById('date_fin').value;
        const selectionMode = document.querySelector('input[name="selection_mode"]:checked').value;
        
        if (!dateDebut || !dateFin) {
            showMessage('Veuillez s√©lectionner les dates de d√©but et de fin.', 'warning');
            return;
        }
        
        // Validation selon le mode de s√©lection
        if (selectionMode === 'individual') {
            const selectedArticles = document.querySelectorAll('input[name="articles"]:checked');
            if (selectedArticles.length === 0) {
                showMessage('Veuillez s√©lectionner au moins un article.', 'warning');
                return;
            }
        } else if (selectionMode === 'range') {
            const articleDebut = document.getElementById('article_debut').value;
            const articleFin = document.getElementById('article_fin').value;
            
            if (!articleDebut || !articleFin) {
                showMessage('Veuillez s√©lectionner les articles de d√©but et de fin.', 'warning');
                return;
            }
            
            // V√©rifier l'ordre alphab√©tique
            const debutText = document.getElementById('article_debut').options[document.getElementById('article_debut').selectedIndex].text.split(' (')[0];
            const finText = document.getElementById('article_fin').options[document.getElementById('article_fin').selectedIndex].text.split(' (')[0];
            
            if (debutText > finText) {
                showMessage('L\'article de d√©but doit √™tre alphab√©tiquement avant l\'article de fin.', 'warning');
                return;
            }
        }
        
        if (new Date(dateDebut) > new Date(dateFin)) {
            showMessage('La date de d√©but doit √™tre ant√©rieure √† la date de fin.', 'warning');
            return;
        }
        
        showLoading();
        submitForm();
    });
});

function submitForm() {
    const form = document.getElementById('mouvementsForm');
    const formData = new FormData(form);
    const selectionMode = document.querySelector('input[name="selection_mode"]:checked').value;
    
    // G√©rer la s√©lection par plage - les articles sont d√©j√† s√©lectionn√©s automatiquement
    if (selectionMode === 'range') {
        // Les articles dans la plage sont d√©j√† s√©lectionn√©s via selectArticlesInRange()
        // On utilise le mode individuel avec les articles pr√©-s√©lectionn√©s
        formData.append('selection_mode', 'individual');
    } else {
        // Mode individuel - garder les articles s√©lectionn√©s
        formData.append('selection_mode', 'individual');
    }
    
    fetch('{% url "consulter_mouvements_stock" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        console.log('Donn√©es re√ßues:', data); // Debug
        console.log('Premier mouvement re√ßu:', data.mouvements ? data.mouvements[0] : 'AUCUN'); // Debug
        
        if (data.success) {
            displayMouvements(data);
            showMessage('Mouvements consult√©s avec succ√®s !', 'success');
        } else {
            showMessage('Erreur: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showMessage('Erreur lors de la consultation des mouvements.', 'danger');
        console.error('Error:', error);
    });
}

function displayMouvements(data) {
    const resultsSection = document.getElementById('results-section');
    const summaryDiv = document.getElementById('mouvements-summary');
    const tbody = document.getElementById('mouvements-tbody');
    
    console.log('displayMouvements appel√© avec:', data); // Debug
    console.log('Nombre de mouvements:', data.mouvements ? data.mouvements.length : 0); // Debug
    console.log('Premier mouvement:', data.mouvements ? data.mouvements[0] : 'AUCUN'); // Debug
    
    // Affichage des r√©sultats
    resultsSection.style.display = 'block';
    
    // R√©sum√©
    let articlesSummary = '';
    if (data.articles_info && data.articles_info.length > 0) {
        articlesSummary = data.articles_info.map(article => 
            `${article.reference} - ${article.designation} (${article.mouvements_count} mouvements)`
        ).join('<br>');
    }
    
    summaryDiv.innerHTML = `
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle"></i> R√©sum√© des Mouvements</h6>
            <div class="row">
                <div class="col-md-12">
                    <strong>Articles consult√©s:</strong><br>
                    ${articlesSummary}
            </div>
            </div>
            <div class="row" style="margin-top: 15px;">
                <div class="col-md-4">
                    <strong>P√©riode:</strong> ${new Date(data.date_debut).toLocaleDateString('fr-FR')} au ${new Date(data.date_fin).toLocaleDateString('fr-FR')}
            </div>
                <div class="col-md-4">
                    <strong>Total mouvements:</strong> ${data.total_mouvements}
            </div>
                <div class="col-md-4">
                    <strong>Valeur stock permanent:</strong> ${Number(data.valeur_stock_permanent).toLocaleString()} FCFA
                </div>
            </div>
        </div>
    `;
    
    // Mettre √† jour les informations d'en-t√™te Excel
    document.getElementById('date-debut-display').textContent = data.date_debut;
    document.getElementById('date-fin-display').textContent = data.date_fin;
    document.getElementById('date-tirage').textContent = new Date().toLocaleDateString('fr-FR');
    
    
    // Tableau des mouvements au format Excel
    if (data.mouvements && data.mouvements.length > 0) {
        let tbodyHtml = '';
        data.mouvements.forEach((mouvement, index) => {
            console.log('üîç MOUVEMENT DEBUG:', mouvement); // Debug pour voir les donn√©es
            console.log('üîç D√âSIGNATION:', mouvement.designation); // Debug sp√©cifique pour la d√©signation
            console.log('üîç R√âF√âRENCE:', mouvement.reference_article); // Debug sp√©cifique pour la r√©f√©rence
            console.log('üîç TOUTES LES CL√âS:', Object.keys(mouvement)); // Debug pour voir toutes les propri√©t√©s disponibles
            
            // Solution de contournement : r√©cup√©rer les donn√©es depuis articles_info
            let articleInfo = null;
            if (data.articles_info && data.articles_info.length > 0) {
                // Essayer de trouver l'article correspondant
                articleInfo = data.articles_info.find(article => 
                    article.reference === mouvement.reference_article || 
                    article.designation === mouvement.designation
                );
            }
            
            // Utiliser les donn√©es de l'article si disponibles
            const reference = mouvement.reference_article || (articleInfo ? articleInfo.reference : 'N/A');
            const designation = mouvement.designation || (articleInfo ? articleInfo.designation : 'N/A');
            const date = new Date(mouvement.date_mouvement);
            const dateStr = date.toLocaleDateString('fr-FR');
            
            // D√©terminer le type de mouvement avec des libell√©s clairs
            let typeDisplay = '';
            if (mouvement.type_mouvement === 'entree') {
                typeDisplay = 'Entr√©e'; // Entr√©e de stock
            } else if (mouvement.type_mouvement === 'sortie') {
                typeDisplay = 'Sortie'; // Sortie de stock
            } else if (mouvement.type_mouvement === 'report') {
                typeDisplay = 'Report';
            } else if (mouvement.type_mouvement === 'ajustement') {
                typeDisplay = 'Ajustement';
            } else if (mouvement.type_mouvement === 'inventaire') {
                typeDisplay = 'Inventaire';
            } else if (mouvement.type_mouvement === 'transfert') {
                typeDisplay = 'Transfert';
            } else if (mouvement.type_mouvement === 'perte') {
                typeDisplay = 'Perte';
            } else if (mouvement.type_mouvement === 'retour') {
                typeDisplay = 'Retour';
            } else {
                typeDisplay = mouvement.type_mouvement_display || mouvement.type_mouvement;
            }
            
            const quantite = mouvement.quantite;
            // Pour les sorties, afficher un signe moins, pour les entr√©es un signe plus
            let quantiteDisplay;
            if (mouvement.type_mouvement === 'sortie' || mouvement.type_mouvement === 'perte') {
                // Sorties et pertes : toujours afficher avec signe moins
                quantiteDisplay = quantite < 0 ? quantite.toString() : `-${Math.abs(quantite)}`;
            } else if (mouvement.type_mouvement === 'entree' || mouvement.type_mouvement === 'retour') {
                // Entr√©es et retours : afficher avec signe plus
                quantiteDisplay = quantite > 0 ? `+${quantite}` : quantite.toString();
            } else {
                // Autres types : afficher tel quel avec signe selon la valeur
                quantiteDisplay = quantite > 0 ? `+${quantite}` : quantite.toString();
            }
            
            tbodyHtml += `
                <tr>
                    <td>${dateStr}</td>
                    <td>${typeDisplay}</td>
                    <td></td>
                    <td>${mouvement.numero_piece || ''}</td>
                    <td></td>
                    <td></td>
                    <td>${mouvement.tiers || ''}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>${quantiteDisplay}</td>
                    <td>${mouvement.stock_initial}</td>
                    <td>${mouvement.solde}</td>
                    <td>${Number(mouvement.cout_moyen_pondere).toLocaleString('fr-FR')}</td>
                    <td></td>
                    <td></td>
                    <td>${Number(mouvement.stock_permanent).toLocaleString('fr-FR')}</td>
                </tr>
            `;
        });
        tbody.innerHTML = tbodyHtml;
        
        // Mettre √† jour le total g√©n√©ral
        document.getElementById('total-stock-permanent').textContent = 
            Number(data.valeur_stock_permanent).toLocaleString('fr-FR') + ' FCFA';
            
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="17" class="text-center text-muted">
                        <i class="fas fa-info-circle"></i> Aucun mouvement trouv√© pour les crit√®res s√©lectionn√©s
                    </td>
                </tr>
            `;
        }
    
    // Faire d√©filer vers les r√©sultats
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}

function getTypeClass(type) {
    const classes = {
        'entree': 'entree',
        'sortie': 'sortie',
        'ajustement': 'ajustement',
        'inventaire': 'inventaire',
        'transfert': 'transfert',
        'perte': 'perte',
        'retour': 'retour'
    };
    return classes[type] || 'ajustement';
}

function getTypeLabel(type) {
    const labels = {
        'entree': 'Entr√©e',
        'sortie': 'Sortie',
        'ajustement': 'Ajustement',
        'inventaire': 'Inventaire',
        'transfert': 'Transfert',
        'perte': 'Perte',
        'retour': 'Retour'
    };
    return labels[type] || type;
}

function showLoading() {
    const loadingSpinner = document.createElement('div');
    loadingSpinner.id = 'loading-spinner';
    loadingSpinner.className = 'loading-spinner';
    loadingSpinner.innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Chargement...</span>
        </div>
        <p class="mt-2">Consultation des mouvements en cours...</p>
    `;
    
    document.getElementById('mouvementsForm').appendChild(loadingSpinner);
    loadingSpinner.style.display = 'block';
}

function hideLoading() {
    const loadingSpinner = document.getElementById('loading-spinner');
    if (loadingSpinner) {
        loadingSpinner.remove();
    }
}

function showMessage(message, type) {
    const messagesContainer = document.getElementById('messages-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
    `;
    
    messagesContainer.appendChild(alertDiv);
    
    // Auto-supprimer apr√®s 5 secondes
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

</script>
{% endblock %}
