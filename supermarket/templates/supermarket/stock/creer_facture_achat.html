{% extends 'supermarket/stock/base_stock.html' %}
{% load static %}

{% block title %}Créer Facture d'Achat{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        position: relative;
        overflow-x: hidden;
    }

    body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
        z-index: -1;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
        z-index: 1;
    }

    .main-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.1),
            0 0 0 1px rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        overflow: hidden;
        margin-bottom: 20px;
    }

    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 40px;
        text-align: center;
        position: relative;
    }

    .form-header h2 {
        margin: 0;
        font-size: 1.8em;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .form-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1em;
    }

    .form-content {
        padding: 40px;
    }

    .form-group {
        margin-bottom: 35px;
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        border: 1px solid #e9ecef;
        position: relative;
        transition: all 0.3s ease;
    }

    .form-group:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .form-group-title {
        font-size: 1.2em;
        font-weight: 700;
        color: #495057;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-group-title i {
        color: #667eea;
        font-size: 1.1em;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-bottom: 20px;
    }

    .form-row.triple {
        grid-template-columns: 1fr 1fr 1fr;
    }

    .form-field {
        display: flex;
        flex-direction: column;
    }

    .form-field label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-field label i {
        color: #667eea;
        font-size: 0.9em;
    }

    .required {
        color: #dc3545;
        font-weight: 700;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
        padding: 12px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 0.95em;
        transition: all 0.3s ease;
        background: white;
        font-family: inherit;
        width: 100%;
        box-sizing: border-box;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-1px);
    }

    .help-text {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 5px;
        font-style: italic;
    }

    .articles-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 35px;
        border: 1px solid #e9ecef;
    }

    .articles-section h3 {
        font-size: 1.2em;
        font-weight: 700;
        color: #495057;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .articles-section h3 i {
        color: #667eea;
        font-size: 1.1em;
    }

    .article-selector {
        background: #ffffff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .selected-articles {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e9ecef;
    }

    .selected-articles h4 {
        margin: 0 0 15px 0;
        color: #495057;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .total-display {
        text-align: right;
        margin-bottom: 15px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 8px;
        font-weight: 600;
        color: #495057;
    }

    #articles-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #articles-table thead {
        background: #667eea;
        color: white;
    }

    #articles-table th {
        padding: 15px 10px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9em;
    }

    #articles-table td {
        padding: 12px 10px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
    }

    #articles-table tbody tr:hover {
        background: #f8f9fa;
    }

    .no-articles {
        text-align: center;
        color: #6c757d;
        padding: 30px;
        font-style: italic;
    }

    .no-articles i {
        font-size: 2em;
        margin-bottom: 10px;
        opacity: 0.5;
        display: block;
    }

    .quantity-input, .price-input {
        width: 80px;
        padding: 5px 8px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        text-align: center;
        font-size: 0.9em;
    }

    .quantity-input:focus, .price-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .delete-button {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 0.8em;
        transition: all 0.3s ease;
    }

    .delete-button:hover {
        background: #c82333;
        transform: scale(1.05);
    }

    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .search-result-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        transition: background 0.2s ease;
    }

    .search-result-item:hover {
        background: #f8f9fa;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 3px;
    }

    .search-result-details {
        font-size: 0.85em;
        color: #6c757d;
    }

    .total-section {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 35px;
        text-align: center;
    }

    .total-section h3 {
        margin: 0 0 15px 0;
        font-size: 1.3em;
        font-weight: 700;
    }

    .total-amount {
        font-size: 2em;
        font-weight: 700;
        margin: 10px 0;
    }

    .no-articles {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 40px;
    }

    .form-actions {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid rgba(0, 0, 0, 0.05);
    }

    .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 12px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
        min-width: 150px;
        justify-content: center;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
    }

    .btn-secondary[onclick*="resetForm"] {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-secondary[onclick*="resetForm"]:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    }

    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        border: 1px solid transparent;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-error,
    .alert-danger {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .alert-warning {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    .alert-info {
        background: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    @media (max-width: 768px) {
        .form-row,
        .form-row.triple {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-content {
            padding: 20px;
        }

        .article-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .article-actions {
            width: 100%;
            justify-content: flex-end;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="main-card">
        <div class="form-header">
                <h2><i class="fas fa-file-invoice"></i> Créer Facture d'Achat</h2>
                <p>Enregistrer une nouvelle facture d'achat et ses détails</p>
        </div>
        
        <div class="form-content">
            <form method="POST" id="facture-form">
                {% csrf_token %}
                <input type="hidden" id="articles_data" name="articles_data" value="">
                
                <!-- Messages -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            <i class="fas fa-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
                
                <!-- Informations générales -->
                <div class="form-group">
                    <div class="form-group-title">
                        <i class="fas fa-info-circle"></i>
                        Informations Générales
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label for="numero_fournisseur">
                                <i class="fas fa-truck"></i>
                                Numéro Fournisseur <span class="required">*</span>
                            </label>
                            <input type="text" id="numero_fournisseur" name="numero_fournisseur" required>
                            <div class="help-text">Numéro d'identification du fournisseur</div>
                        </div>

                        <div class="form-field">
                            <label for="reference_achat">
                                <i class="fas fa-barcode"></i>
                                Référence Achat <span class="required">*</span>
                            </label>
                            <input type="text" id="reference_achat" name="reference_achat" required>
                            <div class="help-text">Référence unique de la facture d'achat</div>
                        </div>
                    </div>

                    <div class="form-row triple">
                        <div class="form-field">
                            <label for="date_achat">
                                <i class="fas fa-calendar"></i>
                                Date d'Achat <span class="required">*</span>
                            </label>
                            <input type="date" id="date_achat" name="date_achat" required>
                            <div class="help-text">Date de la facture d'achat</div>
                        </div>

                        <div class="form-field">
                            <label for="heure">
                                <i class="fas fa-clock"></i>
                                Heure <span class="required">*</span>
                            </label>
                            <input type="time" id="heure" name="heure" required>
                            <div class="help-text">Heure de la facture</div>
                        </div>

                        <div class="form-field">
                            <label for="statut">
                                <i class="fas fa-tasks"></i>
                                Statut
                            </label>
                            <select id="statut" name="statut">
                                {% for value, label in statut_choices %}
                                    <option value="{{ value }}" {% if value == 'brouillon' %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="help-text">Statut de la facture</div>
                    </div>
                </div>

                    <div class="form-field">
                        <label for="commentaire">
                            <i class="fas fa-comment"></i>
                            Commentaire
                        </label>
                        <textarea id="commentaire" name="commentaire" 
                                  placeholder="Commentaires sur la facture d'achat"></textarea>
                        <div class="help-text">Commentaires optionnels</div>
                    </div>
                    </div>
                    
                <!-- Articles -->
                    <div class="articles-section">
                    <h3><i class="fas fa-boxes"></i> Articles de la Facture</h3>
                    
                        <div class="article-selector">
                            <div class="form-field">
                                <label for="article_search">
                                    <i class="fas fa-search"></i>
                                    Rechercher un Article
                                </label>
                                <input type="text" id="article_search" placeholder="Tapez au moins 2 lettres pour rechercher" onkeyup="searchArticles()">
                                <div class="help-text">Commencez à taper pour rechercher un article</div>
                            </div>
                        </div>
                        
                        <div class="selected-articles">
                            <h4><i class="fas fa-list"></i> Articles Sélectionnés</h4>
                            <div class="total-display">
                            <span id="total-quantity">Quantité Totale: 0</span>
                            </div>
                            <table id="articles-table">
                                <thead>
                                    <tr>
                                        <th>Désignation</th>
                                        <th>Quantité</th>
                                        <th>Prix d'Achat</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="no-articles-row">
                                        <td colspan="5" class="no-articles">
                                            <i class="fas fa-info-circle"></i>
                                            <p>Aucun article sélectionné</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                    </div>
                </div>

                <!-- Total -->
                <div class="total-section">
                    <h3><i class="fas fa-calculator"></i> Total de la Facture</h3>
                    <div class="total-amount" id="total-amount">0.00 FCFA</div>
                    <input type="hidden" id="prix_total_global" name="prix_total_global" value="0">
                </div>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Enregistrer la Facture
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <a href="{% url 'dashboard_stock' %}" class="btn btn-secondary">
                        <i class="fas fa-home"></i>
                        Retour Dashboard
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Fonction pour réinitialiser le formulaire
function resetForm() {
    // Vérifier s'il y a des données saisies
    const form = document.getElementById('facture-form');
    const formData = new FormData(form);
    
    // Vérifier les champs principaux
    const fieldsToCheck = [
        'numero_fournisseur',
        'date_achat', 
        'heure',
        'reference_achat',
        'prix_total_global',
        'commentaire'
    ];
    
    let hasData = false;
    
    for (const field of fieldsToCheck) {
        const value = formData.get(field);
        if (value && value.trim() !== '') {
            hasData = true;
            break;
        }
    }
    
    // Vérifier s'il y a des articles ajoutés
    const articlesData = document.getElementById('articles_data').value;
    if (articlesData && articlesData !== '[]') {
        hasData = true;
    }
    
    if (hasData) {
        if (confirm('Vous avez des données saisies. Êtes-vous sûr de vouloir réinitialiser le formulaire ? Toutes les données seront perdues.')) {
            resetFormFields();
        }
    } else {
        resetFormFields();
    }
}

// Fonction pour réinitialiser tous les champs du formulaire
function resetFormFields() {
    // Réinitialiser le formulaire
    document.getElementById('facture-form').reset();
    
    // Réinitialiser les champs de recherche et articles
    document.getElementById('article_search').value = '';
    document.getElementById('articles_data').value = '';
    
    // Vider la table des articles
    const tbody = document.querySelector('#articles-table tbody');
    if (tbody) {
        tbody.innerHTML = '';
    }
    
    // Réinitialiser le total
    totalAmount = 0;
    document.getElementById('total-amount').textContent = '0.00 FCFA';
    document.getElementById('prix_total_global').value = '0';
    
    // Masquer les messages d'erreur/succès s'il y en a
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => alert.remove());
    
    // Message de confirmation
    const form = document.getElementById('facture-form');
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success';
    alertDiv.innerHTML = '<i class="fas fa-check-circle"></i> Formulaire réinitialisé avec succès.';
    form.insertBefore(alertDiv, form.firstChild);
    
    // Supprimer le message après 3 secondes
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Variables globales
let searchTimeout;
let totalAmount = 0;

// Fonction de recherche d'articles
function searchArticles() {
    const searchTerm = document.getElementById('article_search').value.trim();
    
    clearTimeout(searchTimeout);
    
    searchTimeout = setTimeout(() => {
        if (searchTerm.length >= 1) {
            // Requête AJAX vers le serveur pour récupérer les vrais articles
            fetch(`{% url 'search_articles_stock' %}?q=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Recherche pour:', searchTerm);
                    console.log('Articles trouvés:', data.articles);
                    
                    // Si aucun article trouvé, utiliser des données simulées temporairement
                    if (data.articles.length === 0) {
                        console.log('Aucun article trouvé, utilisation de données simulées');
                        const mockArticles = [
                            { id: 1, designation: 'Ordinateur Portable', prix_achat: 500000, stock: 10, reference_article: 'ORD001' },
                            { id: 2, designation: 'Souris USB', prix_achat: 5000, stock: 50, reference_article: 'SOU001' },
                            { id: 3, designation: 'Clavier Mécanique', prix_achat: 15000, stock: 25, reference_article: 'CLA001' },
                            { id: 4, designation: 'Écran 24 pouces', prix_achat: 80000, stock: 15, reference_article: 'ECR001' },
                            { id: 5, designation: 'Casque Audio', prix_achat: 25000, stock: 30, reference_article: 'CAS001' },
                        ];
                        
                        const filteredArticles = mockArticles.filter(article => 
                            article.designation.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            article.reference_article.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                        showSearchResults(filteredArticles);
                    } else {
                    showSearchResults(data.articles);
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la recherche:', error);
                    showSearchResults([]);
                });
        } else {
            hideSearchResults();
        }
    }, 300);
}

// Afficher les résultats de recherche
function showSearchResults(articles) {
    const searchInput = document.getElementById('article_search');
    let searchResults = document.getElementById('search_results');
    
    if (!searchResults) {
        // Créer le conteneur des résultats s'il n'existe pas
        searchResults = document.createElement('div');
        searchResults.id = 'search_results';
        searchResults.className = 'search-results';
        searchInput.parentNode.style.position = 'relative';
        searchInput.parentNode.appendChild(searchResults);
    }
    
    searchResults.innerHTML = '';
    
    if (articles.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item">Aucun article trouvé</div>';
    } else {
        articles.forEach(article => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.innerHTML = `
                <div class="search-result-name">${article.reference_article || ''} - ${article.designation}</div>
                <div class="search-result-details">Prix: ${article.prix_achat.toLocaleString()} FCFA | Stock: ${article.stock || 0}</div>
            `;
            item.onclick = () => addArticleToTable(article.id, article.designation, article.prix_achat, article.stock || 0, article.reference_article || '');
            searchResults.appendChild(item);
        });
    }
    
    searchResults.style.display = 'block';
    console.log('Résultats affichés:', searchResults.style.display);
}

// Masquer les résultats de recherche
function hideSearchResults() {
    const searchResults = document.getElementById('search_results');
    if (searchResults) {
        searchResults.style.display = 'none';
    }
}

// Ajouter un article au tableau
function addArticleToTable(articleId, designation, prixAchat, stock, reference = '') {
    const tbody = document.querySelector('#articles-table tbody');
    if (!tbody) return;
    
    // Vérifier si l'article existe déjà
    const existingRow = tbody.querySelector(`tr[data-article-id="${articleId}"]`);
    if (existingRow) {
        // Augmenter la quantité si l'article existe déjà
        const quantiteInput = existingRow.querySelector('.quantity-input');
        const currentQuantity = parseFloat(quantiteInput.value) || 1;
        const newQuantity = currentQuantity + 1;
        quantiteInput.value = newQuantity;
        updateRowTotal(existingRow);
        updateTotalQuantity();
        hideSearchResults();
        return;
    }
    
    // Supprimer la ligne "aucun article" si elle existe
    const noArticlesRow = tbody.querySelector('.no-articles-row');
    if (noArticlesRow) {
        noArticlesRow.remove();
    }
    
    // Créer une nouvelle ligne
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-article-id', articleId);
    newRow.innerHTML = `
        <td>${reference ? reference + ' - ' : ''}${designation}</td>
        <td>
            <input type="number" class="quantity-input" value="1" min="0" step="0.01" 
                   onchange="updateRowTotal(this.closest('tr'))" 
                   oninput="updateRowTotal(this.closest('tr'))">
        </td>
        <td>
            <input type="number" class="price-input" value="${prixAchat}" min="0" step="0.01"
                   onchange="updateRowTotal(this.closest('tr'))" 
                   oninput="updateRowTotal(this.closest('tr'))">
        </td>
        <td class="total-cell">${prixAchat.toLocaleString()} FCFA</td>
        <td>
            <button type="button" class="delete-button" onclick="removeArticleFromTable(this.closest('tr'))">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    updateRowTotal(newRow); // Mettre à jour le total de la ligne et recalculer le total global
    updateTotalQuantity();
    updateTotalAmount(); // S'assurer que le total global est mis à jour
    hideSearchResults();
    document.getElementById('article_search').value = '';
}

// Fonction pour normaliser les entrées décimales
function normalizeDecimalInput(value) {
    if (value === null || value === undefined) return 0;
    let valueStr = String(value).trim();
    // Remplacer les virgules par des points (format français vers international)
    valueStr = valueStr.replace(',', '.');
    // Supprimer les caractères non numériques sauf point et moins
    valueStr = valueStr.replace(/[^\d.-]/g, '');
    // Supprimer les espaces (séparateurs de milliers)
    valueStr = valueStr.replace(/\s/g, '');
    if (!valueStr || valueStr === '-' || valueStr === '.') return 0;
    // Gérer les multiples points décimaux
    const parts = valueStr.split('.');
    if (parts.length > 2) {
        valueStr = parts[0] + '.' + parts.slice(1).join('');
    }
    const result = parseFloat(valueStr);
    return isNaN(result) ? 0 : result;
}

// Mettre à jour le total d'une ligne
function updateRowTotal(row) {
    const quantiteInput = row.querySelector('.quantity-input');
    const priceInput = row.querySelector('.price-input');
    const totalCell = row.querySelector('.total-cell');
    
    const quantite = normalizeDecimalInput(quantiteInput.value);
    const prix = normalizeDecimalInput(priceInput.value);
    const total = Math.round((quantite * prix) * 100) / 100; // Arrondir à 2 décimales
    
    totalCell.textContent = total.toLocaleString('fr-FR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) + ' FCFA';
    updateTotalQuantity();
    updateTotalAmount();
}

// Supprimer un article du tableau
function removeArticleFromTable(row) {
    row.remove();
    
    // Vérifier s'il reste des articles
    const tbody = document.querySelector('#articles-table tbody');
    const remainingRows = tbody.querySelectorAll('tr[data-article-id]');
    
    if (remainingRows.length === 0) {
        // Ajouter la ligne "aucun article"
        const noArticlesRow = document.createElement('tr');
        noArticlesRow.className = 'no-articles-row';
        noArticlesRow.innerHTML = `
            <td colspan="5" class="no-articles">
                <i class="fas fa-info-circle"></i>
                <p>Aucun article sélectionné</p>
            </td>
        `;
        tbody.appendChild(noArticlesRow);
    }
    
    updateTotalQuantity();
    updateTotalAmount();
}

// Mettre à jour la quantité totale
function updateTotalQuantity() {
    let totalQuantity = 0;
    const rows = document.querySelectorAll('#articles-table tbody tr[data-article-id]');
    
    rows.forEach(row => {
        const quantiteInput = row.querySelector('.quantity-input');
        if (quantiteInput) {
            const quantite = normalizeDecimalInput(quantiteInput.value);
            totalQuantity += quantite;
        }
    });
    
    document.getElementById('total-quantity').textContent = `Quantité Totale: ${totalQuantity.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// Mettre à jour le montant total
function updateTotalAmount() {
    let total = 0;
    const rows = document.querySelectorAll('#articles-table tbody tr[data-article-id]');
    
    rows.forEach(row => {
        const quantiteInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.price-input');
        if (quantiteInput && priceInput) {
            const quantite = normalizeDecimalInput(quantiteInput.value);
            const prix = normalizeDecimalInput(priceInput.value);
            total += Math.round((quantite * prix) * 100) / 100; // Arrondir à 2 décimales
        }
    });
    
    totalAmount = total;
    document.getElementById('total-amount').textContent = total.toLocaleString('fr-FR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) + ' FCFA';
    document.getElementById('prix_total_global').value = total.toFixed(2);
}

// Préparer les données des articles avant soumission
document.getElementById('facture-form').addEventListener('submit', function(e) {
    const articles = [];
    const rows = document.querySelectorAll('#articles-table tbody tr[data-article-id]');
    
    rows.forEach(row => {
        const articleId = row.getAttribute('data-article-id');
        const designation = row.cells[0].textContent.trim();
        const quantite = row.querySelector('.quantity-input').value;
        const prixAchat = row.querySelector('.price-input').value;
        
            if (articleId && quantite && prixAchat) {
                articles.push({
                    id: articleId,
                    designation: designation,
                    quantite: quantite,
                    prix_achat: prixAchat
                });
            }
        });
    
    // Validation des champs obligatoires
    const numeroFournisseur = document.getElementById('numero_fournisseur').value.trim();
    const referenceAchat = document.getElementById('reference_achat').value.trim();
    const dateAchat = document.getElementById('date_achat').value;
    const heure = document.getElementById('heure').value;

    if (!numeroFournisseur) {
        e.preventDefault();
        alert('Le numéro fournisseur est obligatoire.');
        return false;
    }

    if (!referenceAchat) {
        e.preventDefault();
        alert('La référence achat est obligatoire.');
        return false;
    }

    if (!dateAchat) {
        e.preventDefault();
        alert('La date d\'achat est obligatoire.');
        return false;
    }

    if (!heure) {
        e.preventDefault();
        alert('L\'heure est obligatoire.');
        return false;
    }

    if (articles.length === 0) {
        e.preventDefault();
        alert('Veuillez ajouter au moins un article à la facture.');
        return false;
    }

    if (totalAmount <= 0) {
        e.preventDefault();
        alert('Le total de la facture doit être supérieur à 0.');
        return false;
    }
    
    // Mettre à jour le champ caché
    document.getElementById('articles_data').value = JSON.stringify(articles);
    console.log('Articles à acheter:', articles);

    // Confirmation avant soumission
    if (!confirm(`Êtes-vous sûr de vouloir créer cette facture d'achat pour un montant de ${totalAmount.toFixed(2)} FCFA ?`)) {
        e.preventDefault();
        return false;
    }
});

// Événements
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser la date et l'heure d'aujourd'hui SEULEMENT si les champs sont vides
    const dateField = document.getElementById('date_achat');
    const timeField = document.getElementById('heure');
    
    if (!dateField.value) {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        dateField.value = today;
    }
    
    if (!timeField.value) {
        const now = new Date();
        const currentTime = now.toTimeString().slice(0, 5);
        timeField.value = currentTime;
    }
    
    const searchInput = document.getElementById('article_search');
    
    // Masquer les résultats quand on clique ailleurs
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#article_search') && !e.target.closest('#search_results')) {
            hideSearchResults();
        }
    });
    
    // Focus sur le champ de recherche
    if (searchInput) {
        searchInput.focus();
    }
    
    // Initialiser le total si nécessaire au chargement de la page
    updateTotalAmount();
});
</script>
{% endblock %}
