<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tail des Factures</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .filters-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .filters-row {
        display: grid;
        grid-template-columns: 2fr 1fr auto;
        gap: 15px;
        align-items: end;
    }
    
    .search-input {
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #d74123;
    }
    
    .filter-select {
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1em;
        background: white;
        cursor: pointer;
    }
    
    .btn-search {
        background: linear-gradient(135deg, #d74123, #ff6b35);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-search:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(215, 65, 35, 0.3);
    }
    
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border-left: 4px solid #d74123;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        color: #2c3e50;
        font-size: 1.8em;
        font-weight: 700;
    }
    
    .factures-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .table-header {
        background: linear-gradient(135deg, #d74123, #ff6b35);
        color: white;
        padding: 20px;
        font-weight: 600;
        font-size: 1.1em;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
    }
    
    .table td {
        padding: 15px 12px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge-success {
        background: #d4edda;
        color: #155724;
    }
    
    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }
    
    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }
    
    .btn-action {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .btn-view {
        background: #17a2b8;
        color: white;
    }
    
    .btn-edit {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-delete {
        background: #dc3545;
        color: white;
    }
    
    .btn-primary {
        background: #28a745;
        color: white;
    }
    
    .btn-action:hover {
        transform: translateY(-1px);
        opacity: 0.9;
    }
    
    .view-details-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8em;
        transition: background 0.3s;
    }
    
    .view-details-btn:hover {
        background: #0056b3;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #d74123 0%, #ff6b35 100%);
        color: white;
        padding: 20px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.3em;
    }
    
    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
    }
    
    .close:hover {
        opacity: 0.7;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .invoice-details {
        margin-bottom: 20px;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .detail-label {
        font-weight: bold;
        color: #333;
    }
    
    .detail-value {
        color: #666;
    }
    
    .articles-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .articles-table th,
    .articles-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e1e5e9;
    }
    
    .articles-table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #333;
    }
    
    .articles-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
    
    .pagination a {
        padding: 8px 12px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        color: #495057;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .pagination a:hover {
        background: #d74123;
        color: white;
        border-color: #d74123;
    }
    
    .pagination .current {
        background: #d74123;
        color: white;
        border-color: #d74123;
    }
    
    @media (max-width: 768px) {
        .filters-row {
            grid-template-columns: 1fr;
        }
        
        .stats-overview {
            grid-template-columns: 1fr;
        }
        
        .table {
            font-size: 0.9em;
        }
        
        .table th,
        .table td {
            padding: 10px 8px;
        }
    }
</style>
</head>
<body>

<!-- Messages Django -->
{% if messages %}
    {% for message in messages %}
        <div style="margin: 10px 0; padding: 10px; border-radius: 5px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<header style="background: linear-gradient(135deg, #d74123 0%, #b8351e 100%); padding: 20px; color: white; text-align: center; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(215, 65, 35, 0.3);">
    <h1 style="font-size: 2.5em; margin: 0; color: white; font-weight: 700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);">
        <i class="fas fa-file-invoice"></i> D√©tail des Factures
    </h1>
    <p style="margin: 10px 0 0 0; opacity: 0.9;">
        {% if employe %}{{ employe.compte.nom }} {{ employe.compte.prenom }}{% else %}{{ user.username }}{% endif %} - {% if agence %}{{ agence.nom_agence }}{% else %}Agence{% endif %}
    </p>
</header>
<div class="filters-section">
    <form method="GET" class="filters-row">
        <input type="text" name="search" class="search-input" 
               placeholder="Rechercher par num√©ro de ticket ou client..." 
               value="{{ search_query }}">
        <select name="date_filter" class="filter-select">
            <option value="all" {% if date_filter == 'all' %}selected{% endif %}>Toutes les dates</option>
            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Aujourd'hui</option>
            <option value="week" {% if date_filter == 'week' %}selected{% endif %}>Cette semaine</option>
            <option value="month" {% if date_filter == 'month' %}selected{% endif %}>Ce mois</option>
        </select>
        <button type="submit" class="btn-search">
            <i class="fas fa-search"></i> Rechercher
        </button>
    </form>
</div>

<div class="stats-overview">
    <div class="stat-card">
        <div class="stat-label">Total Factures</div>
        <div class="stat-value">{{ total_factures|default:0 }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Chiffre d'Affaires Total</div>
        <div class="stat-value">{{ chiffre_affaires_total|default:0|floatformat:2 }} FCFA</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Factures Aujourd'hui</div>
        <div class="stat-value">{{ factures_aujourd_hui|default:0 }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">CA Aujourd'hui</div>
        <div class="stat-value">{{ ca_aujourd_hui|default:0|floatformat:2 }} FCFA</div>
    </div>
</div>

<div class="factures-table">
    <div class="table-header">
        <i class="fas fa-list"></i> Liste des Factures
    </div>
    
    {% if factures %}
    <table class="table">
        <thead>
            <tr>
                <th>N¬∞ Ticket</th>
                <th>Client</th>
                <th>Vendeuse</th>
                <th>Date</th>
                <th>Heure</th>
                <th>Montant</th>
                <th>Statut</th>
                <th>D√©tail</th>
            </tr>
        </thead>
        <tbody>
            {% for facture in factures %}
            <tr>
                <td>
                    <span style="font-weight: bold; color: #d74123;">{{ facture.numero_ticket|default:"N/A" }}</span>
                </td>
                <td>
                    <span style="color: #333; font-weight: 500;">
                        {% if facture.client %}
                            {{ facture.client.intitule|default:"Client anonyme" }}
                        {% else %}
                            Client anonyme
                        {% endif %}
                    </span>
                </td>
                <td>{{ facture.nom_vendeuse|default:"N/A" }}</td>
                <td>
                    <div style="color: #666; font-size: 0.9em;">{{ facture.date|default:""|date:"d/m/Y" }}</div>
                </td>
                <td>
                    <div style="color: #666; font-size: 0.9em;">{{ facture.heure|default:""|time:"H:i" }}</div>
                </td>
                <td>
                    <span style="font-weight: bold; color: #28a745;">{{ facture.nette_a_payer|default:0|floatformat:2 }} FCFA</span>
                </td>
                <td>
                    {% if facture.en_attente %}
                        <span class="badge badge-warning">En attente</span>
                    {% else %}
                        <span class="badge badge-success">Valid√©e</span>
                    {% endif %}
                </td>
                <td>
                    <button class="view-details-btn" data-facture-id="{{ facture.id }}" title="Voir les d√©tails de la facture">
                        <i class="fas fa-eye"></i> Voir d√©tails
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data">
        <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;"></i>
        <p>Aucune facture trouv√©e pour les crit√®res s√©lectionn√©s.</p>
    </div>
    {% endif %}
</div>

<!-- Actions -->
<div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
    <a href="{% url 'dashboard_caisse' %}" style="display: inline-flex; align-items: center; gap: 10px; padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease; text-decoration: none; min-width: 150px; justify-content: center; background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
        <i class="fas fa-home"></i> Retour au Dashboard
    </a>
    <button onclick="window.print()" style="display: inline-flex; align-items: center; gap: 10px; padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease; text-decoration: none; min-width: 150px; justify-content: center; background: linear-gradient(135deg, #d74123, #ff6b35); color: white;">
        <i class="fas fa-print"></i> Imprimer
    </button>
</div>

{% if factures %}
<div class="pagination">
    <!-- Pagination simple - √† am√©liorer avec Django Paginator -->
    <a href="?page=1">&laquo; Premi√®re</a>
    <a href="#" class="current">1</a>
    <a href="?page=2">2</a>
    <a href="?page=3">3</a>
    <a href="?page=2">&raquo; Suivante</a>
</div>
{% endif %}

<!-- Modal pour afficher les d√©tails d'une facture -->
<div id="invoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">D√©tails de la Facture</h2>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Le contenu sera charg√© dynamiquement -->
        </div>
    </div>
</div>

<script>
    const csrfToken = '{{ csrf_token }}';
    
    function attachViewDetailsHandlers() {
        const buttons = document.querySelectorAll('.view-details-btn');
        console.log('Nombre de boutons "Voir d√©tails" trouv√©s:', buttons.length);
        buttons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const factureId = this.getAttribute('data-facture-id');
                console.log('Clic sur bouton, factureId:', factureId);
                if (factureId) {
                    viewInvoiceDetails(factureId);
                } else {
                    console.error('data-facture-id manquant sur le bouton');
                    alert('Erreur: ID de facture manquant');
                }
            });
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM charg√©, attachement des handlers...');
        attachViewDetailsHandlers();
    });

    function viewInvoiceDetails(factureId) {
        console.log('Tentative de chargement des d√©tails pour la facture ID:', factureId);
        
        if (!factureId) {
            console.error('ID de facture manquant');
            alert('ID de facture manquant');
            return;
        }
        
        // R√©cup√©rer les donn√©es de la facture depuis le serveur
        fetch(`/caisse/facture-details/${factureId}/`)
            .then(response => {
                console.log('R√©ponse re√ßue:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Donn√©es re√ßues:', data);
                if (data.success) {
                    displayInvoiceDetails(data.facture);
                } else {
                    alert('Erreur lors du chargement des d√©tails de la facture: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Erreur de chargement:', error);
                alert('Erreur lors du chargement des d√©tails de la facture: ' + error.message);
            });
    }

    function displayInvoiceDetails(facture) {
        console.log('Affichage des d√©tails de la facture:', facture);
        console.log('Nombre de lignes:', facture.lignes ? facture.lignes.length : 0);
        
        const modalBody = document.getElementById('modalBody');
        
        modalBody.innerHTML = `
            <div class="invoice-details">
                <div class="detail-row">
                    <span class="detail-label">Num√©ro de Ticket:</span>
                    <span class="detail-value">${facture.numero_ticket || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Client:</span>
                    <span class="detail-value">${facture.client ? facture.client.intitule : 'Client anonyme'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">${facture.date || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Heure:</span>
                    <span class="detail-value">${facture.heure || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Montant Total:</span>
                    <span class="detail-value" style="font-weight: bold; color: #28a745; font-size: 1.1em;">${(facture.nette_a_payer || 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} FCFA</span>
                </div>
            </div>
            
            ${facture.lignes && facture.lignes.length > 0 ? `
                <h4 style="margin-top: 25px; margin-bottom: 15px; color: #333;">Articles de la facture</h4>
                <table class="articles-table">
                    <thead>
                        <tr>
                            <th>D√©signation</th>
                            <th>R√©f√©rence</th>
                            <th>Quantit√©</th>
                            <th>Prix Unitaire</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${facture.lignes.map(article => `
                            <tr>
                                <td>${article.designation || 'N/A'}</td>
                                <td>${article.reference || 'N/A'}</td>
                                <td>${article.quantite || 0}</td>
                                <td>${(article.prix_unitaire || 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} FCFA</td>
                                <td style="font-weight: bold;">${(article.prix_total || 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} FCFA</td>
                                <td>
                                    ${article.ligne_id ? `
                                        <button type="button"
                                            class="btn-partial-defacturer"
                                            data-facture-id="${facture.id}"
                                            data-ligne-id="${article.ligne_id}"
                                            data-designation="${(article.designation || 'Cet article').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                                            style="background:#ffc107;color:#212529;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.8em;">
                                            <i class="fas fa-undo-alt"></i> D√©facturer
                                        </button>
                                    ` : '<span style="color:#999;">N/A</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="text-align: center; color: #666; margin-top: 20px;">Aucun article trouv√© pour cette facture.</p>'}
            
            <div class="modal-actions" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef; text-align: center; display: flex; gap: 10px; justify-content: center;">
                <button onclick="defacturerFacture(${facture.id})" class="btn-defacturer" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-undo"></i> D√©facturer (avec retour stock)
                </button>
            </div>
        `;

        const modal = document.getElementById('invoiceModal');
        if (!modal) {
            console.error('Modal introuvable dans le DOM');
            alert('Erreur: Modal introuvable');
            return;
        }
        
        console.log('Affichage du modal...');
        modal.style.display = 'block';
        console.log('Modal affich√©, display:', modal.style.display);
        attachPartialDefacturerHandlers();
    }

    function closeModal() {
        document.getElementById('invoiceModal').style.display = 'none';
    }

    function defacturerFacture(factureId) {
        if (confirm('‚ö†Ô∏è ATTENTION: Vous √™tes sur le point de d√©facturer cette vente.\n\nCette action va :\n‚Ä¢ Supprimer la facture\n‚Ä¢ Remettre les produits en stock\n‚Ä¢ Cr√©er des mouvements de stock invers√©s\n\nCette action est IRR√âVERSIBLE !\n\n√ätes-vous s√ªr de vouloir continuer ?')) {
            // Rediriger vers la page de confirmation de d√©facturation
            window.location.href = `/supermarket/stock/defacturer/${factureId}/`;
        }
    }


    function attachPartialDefacturerHandlers() {
        // Supprimer les anciens event listeners pour √©viter les doublons
        document.querySelectorAll('.btn-partial-defacturer').forEach(btn => {
            // Cloner le bouton pour supprimer tous les event listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
        });
        
        // Attacher les nouveaux event listeners
        document.querySelectorAll('.btn-partial-defacturer').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const factureId = this.getAttribute('data-facture-id');
                const ligneId = this.getAttribute('data-ligne-id');
                const designation = this.getAttribute('data-designation') || 'Cet article';
                
                console.log('üî¥ D√©facturation partielle - factureId:', factureId, 'ligneId:', ligneId, 'designation:', designation);
                console.log('üî¥ Bouton cliqu√©:', this);
                console.log('üî¥ Tous les attributs data:', {
                    'data-facture-id': this.getAttribute('data-facture-id'),
                    'data-ligne-id': this.getAttribute('data-ligne-id'),
                    'data-designation': this.getAttribute('data-designation')
                });
                
                if (!factureId || !ligneId || ligneId === 'null' || ligneId === 'undefined') {
                    console.error('‚ùå Donn√©es manquantes - factureId:', factureId, 'ligneId:', ligneId);
                    alert("Erreur: Donn√©es manquantes pour la d√©facturation.");
                    return false;
                }
                
                // Convertir en nombre pour s'assurer que c'est valide
                const factureIdNum = parseInt(factureId, 10);
                const ligneIdNum = parseInt(ligneId, 10);
                
                if (isNaN(factureIdNum) || isNaN(ligneIdNum)) {
                    console.error('‚ùå IDs invalides - factureId:', factureId, 'ligneId:', ligneId);
                    alert("Erreur: IDs invalides pour la d√©facturation.");
                    return false;
                }
                
                defacturerArticle(factureIdNum, ligneIdNum, designation);
                return false;
            });
        });
    }

    function defacturerArticle(factureId, ligneId, designation) {
        console.log('üî¥ defacturerArticle appel√©e avec:', {factureId, ligneId, designation});
        
        if (!ligneId || ligneId === 'null' || ligneId === 'undefined') {
            alert("Impossible de d√©facturer cet article: ID de ligne manquant.");
            return;
        }
        
        const message = `D√©facturer l'article ¬´ ${designation} ¬ª ? Cette action remettra la quantit√© en stock.`;
        if (!confirm(message)) {
            return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/supermarket/stock/defacturer/${factureId}/ligne/${ligneId}/`;
        console.log('üî¥ URL du formulaire:', form.action);
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        console.log('üî¥ Soumission du formulaire pour ligne:', ligneId);
        form.submit();
    }


    // Fermer le modal en cliquant √† l'ext√©rieur
    window.onclick = function(event) {
        const modal = document.getElementById('invoiceModal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>

</body>
</html>
