{% extends 'supermarket/achats/dashboard.html' %}
{% load static %}

{% block content %}
<style>
    .form-container {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .form-section {
        margin-bottom: 30px;
        padding-bottom: 30px;
        border-bottom: 2px solid #ecf0f1;
    }
    
    .form-section:last-child {
        border-bottom: none;
    }
    
    .form-section-title {
        color: #2c3e50;
        font-size: 1.3em;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-section-title i {
        color: #11998e;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.95em;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 1em;
        transition: all 0.3s ease;
        font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #11998e;
        box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .articles-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .articles-table thead {
        background: linear-gradient(135deg, #2d1b69 0%, #11998e 100%);
        color: white;
    }
    
    .articles-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9em;
    }
    
    .articles-table td {
        padding: 15px;
        border-bottom: 1px solid #ecf0f1;
    }
    
    .articles-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .btn-add-article {
        background: linear-gradient(135deg, #2d1b69 0%, #11998e 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-top: 15px;
    }
    
    .btn-add-article:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(45, 27, 105, 0.3);
    }
    
    .btn-remove {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
    }
    
    .btn-remove:hover {
        background: #c82333;
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #2d1b69 0%, #11998e 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1em;
        transition: all 0.3s ease;
        margin-top: 30px;
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(45, 27, 105, 0.3);
    }
    
    .total-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        font-size: 1.1em;
    }
    
    .total-row.final {
        font-size: 1.3em;
        font-weight: 700;
        color: #2c3e50;
        border-top: 2px solid #11998e;
        padding-top: 15px;
        margin-top: 10px;
    }
    
    .logo-container {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        border: 2px solid #dee2e6;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        min-width: 180px;
        min-height: 120px;
    }
    
    .logo-container img {
        max-width: 180px;
        max-height: 120px;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: 8px;
    }
    
    .logo-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 3em;
    }
    
    .logo-placeholder i {
        margin-bottom: 10px;
        opacity: 0.5;
    }
    
    .logo-placeholder span {
        font-size: 0.3em;
        font-weight: 600;
    }
    
    .entreprise-info-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 12px;
        border: 1px solid #e9ecef;
    }
    
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .search-result-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        transition: background 0.2s ease;
    }
    
    .search-result-item:hover {
        background: #f8f9fa;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .search-result-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 3px;
    }
    
    .search-result-details {
        font-size: 0.85em;
        color: #6c757d;
    }
    
    .quantity-input, .price-input {
        width: 100px;
        padding: 8px;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        text-align: center;
        font-size: 0.9em;
    }
    
    .quantity-input:focus, .price-input:focus {
        outline: none;
        border-color: #11998e;
        box-shadow: 0 0 0 2px rgba(17, 153, 142, 0.1);
    }
</style>

<div class="dashboard-header">
    <h2><i class="fas fa-file-invoice" style="color: #11998e;"></i> {% if is_edit %}Modifier{% else %}Générer{% endif %} Bon de Commande Fournisseur{% if is_edit %} - {{ commande.numero_commande }}{% endif %}</h2>
</div>

<form method="POST" id="bonCommandeForm">
    {% csrf_token %}
    
    <!-- Informations Entreprise (En-tête) -->
    <div class="form-container">
        <div class="form-section">
            <h3 class="form-section-title">
                <i class="fas fa-building"></i> Informations Entreprise
            </h3>
            <div class="entreprise-info-wrapper">
                <div class="logo-container">
                    {% if agence.logo %}
                        <img src="{{ agence.logo.url }}" alt="Logo {{ agence.nom_agence }}">
                    {% else %}
                        <div class="logo-placeholder">
                            <i class="fas fa-image"></i>
                            <span>Logo non disponible</span>
                        </div>
                    {% endif %}
                </div>
                <div style="flex: 1;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nom de l'entreprise</label>
                            <input type="text" value="SUPER MARKET" readonly>
                        </div>
                        <div class="form-group">
                            <label>Type d'activité</label>
                            <input type="text" value="GROS - DEMI GROS - DETAIL" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Adresse</label>
                            <input type="text" value="BP 11190 YAOUNDE - {{ agence.nom_agence|default:'AGENCE' }}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Téléphone</label>
                            <input type="text" value="(237) 670930091" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>NUI (Numéro d'Identification Unique)</label>
                            <input type="text" value="P029418061497G" readonly>
                        </div>
                        <div class="form-group">
                            <label>Code postal</label>
                            <input type="text" value="{{ agence.code_postal|default:'Non renseigné' }}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" value="{{ agence.email|default:'Non renseigné' }}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Site web</label>
                            <input type="text" value="{{ agence.site_web|default:'Non renseigné' }}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Informations Fournisseur -->
    <div class="form-container">
        <div class="form-section">
            <h3 class="form-section-title">
                <i class="fas fa-truck"></i> Informations Fournisseur
            </h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="fournisseur_id">Sélectionner un fournisseur existant ({{ fournisseurs|length }} fournisseur{{ fournisseurs|length|pluralize }} disponible{{ fournisseurs|length|pluralize }})</label>
                    <select id="fournisseur_id" name="fournisseur_id" onchange="chargerFournisseur()" style="width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 1em;">
                        <option value="">-- Nouveau fournisseur --</option>
                        {% for fournisseur in fournisseurs %}
                        <option value="{% if fournisseur.id %}{{ fournisseur.id }}{% else %}0{% endif %}" data-nom="{{ fournisseur.nom }}" data-adresse="{{ fournisseur.adresse }}" data-telephone="{{ fournisseur.telephone }}" data-email="{{ fournisseur.email }}" {% if is_edit and commande.fournisseur_id == fournisseur.id %}selected{% endif %}>
                            {{ fournisseur.nom }}{% if fournisseur.telephone %} - {{ fournisseur.telephone }}{% endif %}{% if fournisseur.email %} - {{ fournisseur.email }}{% endif %}
                        </option>
                        {% empty %}
                        <option value="" disabled>Aucun fournisseur trouvé</option>
                        {% endfor %}
                    </select>
                    <small style="color: #6c757d; font-size: 0.85em; margin-top: 5px; display: block;">
                        Sélectionnez un fournisseur pour préremplir automatiquement ses informations, ou choisissez "Nouveau fournisseur" pour en créer un.
                    </small>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="nom_fournisseur">Nom du fournisseur *</label>
                    <input type="text" id="nom_fournisseur" name="nom_fournisseur" value="{% if is_edit %}{{ commande.nom_fournisseur }}{% endif %}" required>
                </div>
                <div class="form-group">
                    <label for="telephone_fournisseur">Téléphone</label>
                    <input type="text" id="telephone_fournisseur" name="telephone_fournisseur" value="{% if is_edit %}{{ commande.telephone_fournisseur }}{% endif %}">
                </div>
            </div>
            <div class="form-group">
                <label for="adresse_fournisseur">Adresse du fournisseur *</label>
                <textarea id="adresse_fournisseur" name="adresse_fournisseur" required>{% if is_edit %}{{ commande.adresse_fournisseur }}{% endif %}</textarea>
            </div>
            <div class="form-group">
                <label for="email_fournisseur">Email</label>
                <input type="email" id="email_fournisseur" name="email_fournisseur" value="{% if is_edit %}{{ commande.email_fournisseur }}{% endif %}">
            </div>
        </div>
    </div>
    
    <!-- Informations Commande -->
    <div class="form-container">
        <div class="form-section">
            <h3 class="form-section-title">
                <i class="fas fa-calendar-alt"></i> Informations Commande
            </h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="date_commande">Date de commande *</label>
                    <input type="date" id="date_commande" name="date_commande" value="{% if is_edit %}{{ commande.date_commande|date:'Y-m-d' }}{% endif %}" required>
                </div>
                <div class="form-group">
                    <label for="date_livraison_prevue">Date de livraison prévue *</label>
                    <input type="date" id="date_livraison_prevue" name="date_livraison_prevue" value="{% if is_edit %}{{ commande.date_livraison_prevue|date:'Y-m-d' }}{% endif %}" required>
                </div>
            </div>
            <div class="form-group">
                <label for="adresse_livraison">Adresse de livraison *</label>
                <textarea id="adresse_livraison" name="adresse_livraison" required>{% if is_edit %}{{ commande.adresse_livraison }}{% elif agence.adresse %}{{ agence.adresse }}{% if agence.code_postal %}, {{ agence.code_postal }}{% endif %}{% if agence.nom_agence %}, {{ agence.nom_agence }}{% endif %}{% endif %}</textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="taux_tva">Taux TVA (%) *</label>
                    <input type="number" id="taux_tva" name="taux_tva" step="0.01" min="0" max="100" value="{% if is_edit %}{{ commande.taux_tva }}{% else %}18.00{% endif %}" required>
                    <small style="color: #6c757d; font-size: 0.85em;">Définir manuellement le taux de TVA (ex: 18 pour 18%)</small>
                </div>
            </div>
            <div class="form-group">
                <label for="commentaire">Commentaire</label>
                <textarea id="commentaire" name="commentaire" placeholder="Notes additionnelles...">{% if is_edit %}{{ commande.commentaire }}{% endif %}</textarea>
            </div>
        </div>
    </div>
    
    <!-- Articles -->
    <div class="form-container">
        <div class="form-section">
            <h3 class="form-section-title">
                <i class="fas fa-boxes"></i> Articles
            </h3>
            
            <div class="form-group" style="position: relative;">
                <label for="article_search">
                    <i class="fas fa-search"></i> Rechercher un Article
                </label>
                <input type="text" id="article_search" placeholder="Tapez au moins 1 lettre pour rechercher" style="width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 1em;">
                <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">Commencez à taper pour rechercher un article</div>
            </div>
            
            <table class="articles-table" id="articlesTable">
                <thead>
                    <tr>
                        <th>Référence</th>
                        <th>Désignation</th>
                        <th>Quantité</th>
                        <th>Prix unitaire</th>
                        <th>Prix total</th>
                        <th>Description</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="articlesBody">
                    <tr class="no-articles-row">
                        <td colspan="7" style="text-align: center; padding: 30px; color: #6c757d; font-style: italic;">
                            <i class="fas fa-info-circle" style="font-size: 2em; opacity: 0.5; display: block; margin-bottom: 10px;"></i>
                            Aucun article sélectionné
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div class="total-section">
                <div class="total-row">
                    <span>Total HT:</span>
                    <span id="totalHT">0 FCFA</span>
                </div>
                <div class="total-row">
                    <span>TVA:</span>
                    <span id="totalTVA">0 FCFA</span>
                </div>
                <div class="total-row final">
                    <span>Total TTC:</span>
                    <span id="totalTTC">0 FCFA</span>
                </div>
            </div>
        </div>
    </div>
    
    <input type="hidden" id="articles_data" name="articles_data" value="">
    
    <div style="text-align: center;">
        <button type="submit" class="btn-submit">
            <i class="fas fa-save"></i> Générer le Bon de Commande
        </button>
    </div>
</form>

<script>
// Variables globales
let searchTimeout;
let totalHT = 0;

// Fonction de recherche d'articles
function searchArticles() {
    const searchTerm = document.getElementById('article_search').value.trim();
    
    clearTimeout(searchTimeout);
    
    searchTimeout = setTimeout(() => {
        if (searchTerm.length >= 1) {
            const url = `{% url 'search_articles_stock' %}?q=${encodeURIComponent(searchTerm)}`;
            console.log('[ACHATS] Recherche articles:', url);
            
            fetch(url, {
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(async response => {
                    console.log('[ACHATS] Réponse reçue:', response.status);
                    if (!response.ok) {
                        const text = await response.text();
                        console.error('[ACHATS] Erreur HTTP:', response.status, text);
                        return { articles: [] };
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('[ACHATS] Articles trouvés:', data.articles);
                    showSearchResults(data.articles || []);
                })
                .catch(error => {
                    console.error('[ACHATS] Erreur lors de la recherche:', error);
                    showSearchResults([]);
                });
        } else {
            hideSearchResults();
        }
    }, 300);
}

// Afficher les résultats de recherche
function showSearchResults(articles) {
    const searchInput = document.getElementById('article_search');
    let searchResults = document.getElementById('search_results');
    
    if (!searchResults) {
        searchResults = document.createElement('div');
        searchResults.id = 'search_results';
        searchResults.className = 'search-results';
        const parent = searchInput.parentNode;
        parent.style.position = 'relative';
        parent.appendChild(searchResults);
    }
    
    searchResults.innerHTML = '';
    
    if (!articles || articles.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item">Aucun article trouvé</div>';
    } else {
        articles.forEach(article => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.innerHTML = `
                <div class="search-result-name">${article.reference_article || ''} - ${article.designation}</div>
                <div class="search-result-details">Prix: ${(article.prix_achat || 0).toLocaleString()} FCFA | Stock: ${article.stock || 0}</div>
            `;
            item.onclick = function() {
                console.log('[ACHATS] Clic sur article:', article);
                addArticleToTable(
                    article.id, 
                    article.designation, 
                    article.prix_achat || 0, 
                    article.stock || 0, 
                    article.reference_article || ''
                );
            };
            searchResults.appendChild(item);
        });
    }
    
    searchResults.style.display = 'block';
    console.log('[ACHATS] Résultats affichés:', articles.length, 'articles');
}

// Masquer les résultats de recherche
function hideSearchResults() {
    const searchResults = document.getElementById('search_results');
    if (searchResults) {
        searchResults.style.display = 'none';
    }
}

// Ajouter un article au tableau
function addArticleToTable(articleId, designation, prixAchat, stock, reference = '') {
    console.log('[ACHATS] addArticleToTable appelé:', { articleId, designation, prixAchat, stock, reference });
    
    const tbody = document.querySelector('#articlesTable tbody') || document.querySelector('#articles-table tbody');
    if (!tbody) {
        console.error('[ACHATS] Tableau tbody introuvable!');
        return;
    }
    
    // Vérifier si l'article existe déjà
    const existingRow = tbody.querySelector(`tr[data-article-id="${articleId}"]`);
    if (existingRow) {
        console.log('[ACHATS] Article existe déjà, augmentation quantité');
        const quantiteInput = existingRow.querySelector('.quantity-input');
        const currentQuantity = parseFloat(quantiteInput.value) || 1;
        quantiteInput.value = currentQuantity + 1;
        updateRowTotal(existingRow);
        hideSearchResults();
        return;
    }
    
    // Supprimer la ligne "aucun article" si elle existe
    const noArticlesRow = tbody.querySelector('.no-articles-row');
    if (noArticlesRow) {
        noArticlesRow.remove();
    }
    
    // Créer une nouvelle ligne
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-article-id', articleId);
    
    const prixAchatNum = parseFloat(prixAchat) || 0;
    
    newRow.innerHTML = `
        <td>${reference || ''}</td>
        <td>${designation}</td>
        <td>
            <input type="number" class="quantity-input" name="quantite[]" value="1" min="0.001" step="0.001" 
                   onchange="updateRowTotal(this.closest('tr'))" 
                   oninput="updateRowTotal(this.closest('tr'))">
        </td>
        <td>
            <input type="number" class="price-input" name="prix_unitaire[]" value="${prixAchatNum}" min="0" step="0.01"
                   onchange="updateRowTotal(this.closest('tr'))" 
                   oninput="updateRowTotal(this.closest('tr'))">
        </td>
        <td class="total-cell">${prixAchatNum.toLocaleString('fr-FR', {minimumFractionDigits: 2})} FCFA</td>
        <td>
            <input type="text" name="description[]" placeholder="Description optionnelle" style="width: 200px; padding: 8px; border: 1px solid #e1e8ed; border-radius: 6px;">
        </td>
        <td>
            <button type="button" class="btn-remove" onclick="removeArticleFromTable(this.closest('tr'))">
                <i class="fas fa-trash"></i>
            </button>
        </td>
        <input type="hidden" name="article_id[]" value="${articleId}">
    `;
    
    tbody.appendChild(newRow);
    console.log('[ACHATS] Article ajouté au tableau');
    updateRowTotal(newRow);
    hideSearchResults();
    document.getElementById('article_search').value = '';
}

// Mettre à jour le total d'une ligne
function updateRowTotal(row) {
    const quantiteInput = row.querySelector('.quantity-input');
    const priceInput = row.querySelector('.price-input');
    const totalCell = row.querySelector('.total-cell');
    
    const quantite = parseFloat(quantiteInput.value) || 0;
    const prix = parseFloat(priceInput.value) || 0;
    const total = Math.round((quantite * prix) * 100) / 100;
    
    totalCell.textContent = total.toLocaleString('fr-FR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) + ' FCFA';
    
    calculerTotaux();
}

// Supprimer un article du tableau
function removeArticleFromTable(row) {
    row.remove();
    
    const tbody = document.querySelector('#articlesTable tbody');
    const remainingRows = tbody.querySelectorAll('tr[data-article-id]');
    
    if (remainingRows.length === 0) {
        const noArticlesRow = document.createElement('tr');
        noArticlesRow.className = 'no-articles-row';
        noArticlesRow.innerHTML = `
            <td colspan="7" style="text-align: center; padding: 30px; color: #6c757d; font-style: italic;">
                <i class="fas fa-info-circle" style="font-size: 2em; opacity: 0.5; display: block; margin-bottom: 10px;"></i>
                Aucun article sélectionné
            </td>
        `;
        tbody.appendChild(noArticlesRow);
    }
    
    calculerTotaux();
}

// Calculer les totaux
function calculerTotaux() {
    let totalHT = 0;
    const rows = document.querySelectorAll('#articlesTable tbody tr[data-article-id]');
    
    rows.forEach(row => {
        const quantite = parseFloat(row.querySelector('.quantity-input').value) || 0;
        const prix = parseFloat(row.querySelector('.price-input').value) || 0;
        totalHT += quantite * prix;
    });
    
    // Récupérer le taux de TVA depuis le champ (par défaut 18%)
    const tauxTVAInput = document.getElementById('taux_tva');
    let tauxTVA = 18.00;
    
    if (tauxTVAInput && tauxTVAInput.value) {
        tauxTVA = parseFloat(tauxTVAInput.value);
        if (isNaN(tauxTVA)) {
            tauxTVA = 18.00;
        }
    }
    
    const totalTVA = totalHT * (tauxTVA / 100);
    const totalTTC = totalHT + totalTVA;
    
    document.getElementById('totalHT').textContent = totalHT.toLocaleString('fr-FR', {minimumFractionDigits: 2}) + ' FCFA';
    document.getElementById('totalTVA').textContent = totalTVA.toLocaleString('fr-FR', {minimumFractionDigits: 2}) + ' FCFA (' + tauxTVA + '%)';
    document.getElementById('totalTTC').textContent = totalTTC.toLocaleString('fr-FR', {minimumFractionDigits: 2}) + ' FCFA';
    
    console.log('[TVA] Taux TVA utilisé:', tauxTVA, '%');
    console.log('[TVA] Total HT:', totalHT, 'Total TVA:', totalTVA);
}

function chargerFournisseur() {
    const select = document.getElementById('fournisseur_id');
    const selectedOption = select.options[select.selectedIndex];
    const fournisseurId = select.value;
    
    if (fournisseurId && fournisseurId !== '0') {
        // Si c'est un fournisseur de la BDD (avec ID), charger via AJAX
        fetch(`/achats/get-fournisseur/${fournisseurId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('nom_fournisseur').value = data.fournisseur.intitule || '';
                    document.getElementById('adresse_fournisseur').value = data.fournisseur.adresse || '';
                    document.getElementById('telephone_fournisseur').value = data.fournisseur.telephone || '';
                    document.getElementById('email_fournisseur').value = data.fournisseur.email || '';
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement du fournisseur:', error);
            });
    } else if (fournisseurId === '0' && selectedOption) {
        // Si c'est un fournisseur depuis les commandes (sans ID en BDD), utiliser les données de l'option
        document.getElementById('nom_fournisseur').value = selectedOption.getAttribute('data-nom') || '';
        document.getElementById('adresse_fournisseur').value = selectedOption.getAttribute('data-adresse') || '';
        document.getElementById('telephone_fournisseur').value = selectedOption.getAttribute('data-telephone') || '';
        document.getElementById('email_fournisseur').value = selectedOption.getAttribute('data-email') || '';
    } else {
        // Réinitialiser les champs si "Nouveau fournisseur" est sélectionné
        document.getElementById('nom_fournisseur').value = '';
        document.getElementById('adresse_fournisseur').value = '';
        document.getElementById('telephone_fournisseur').value = '';
        document.getElementById('email_fournisseur').value = '';
    }
}

// Préparer les données des articles avant soumission
document.getElementById('bonCommandeForm').addEventListener('submit', function(e) {
    const articles = [];
    const rows = document.querySelectorAll('#articlesTable tbody tr[data-article-id]');
    
    rows.forEach(row => {
        const articleId = row.getAttribute('data-article-id');
        const designation = row.cells[1].textContent.trim();
        const quantite = row.querySelector('.quantity-input').value;
        const prixUnitaire = row.querySelector('.price-input').value;
        const description = row.querySelector('input[name="description[]"]').value || '';
        
        if (articleId && quantite && prixUnitaire) {
            articles.push({
                id: articleId,
                designation: designation,
                quantite: quantite,
                prix_unitaire: prixUnitaire,
                description: description
            });
        }
    });
    
    // Mettre à jour le champ caché
    document.getElementById('articles_data').value = JSON.stringify(articles);
    
    // Validation
    if (articles.length === 0) {
        e.preventDefault();
        alert('Veuillez ajouter au moins un article à la commande.');
        return false;
    }
});

// Initialiser la date du jour et préremplir les informations
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    if (!document.getElementById('date_commande').value) {
        document.getElementById('date_commande').value = today;
    }
    
    // Préremplir l'adresse de livraison avec toutes les informations de l'entreprise si elle est vide
    const adresseLivraison = document.getElementById('adresse_livraison');
    if (!adresseLivraison.value.trim()) {
        const adresseParts = [];
        {% if agence.adresse %}
        adresseParts.push('{{ agence.adresse }}');
        {% endif %}
        {% if agence.code_postal %}
        adresseParts.push('{{ agence.code_postal }}');
        {% endif %}
        {% if agence.nom_agence %}
        adresseParts.push('{{ agence.nom_agence }}');
        {% endif %}
        if (adresseParts.length > 0) {
            adresseLivraison.value = adresseParts.join(', ');
        }
    }
    
    // Masquer les résultats quand on clique ailleurs
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#article_search') && !e.target.closest('#search_results')) {
            hideSearchResults();
        }
    });
    
    // Ajouter l'événement de recherche
    document.getElementById('article_search').addEventListener('keyup', searchArticles);
    
    // Mettre à jour les totaux quand le taux de TVA change
    const tauxTVAInput = document.getElementById('taux_tva');
    if (tauxTVAInput) {
        tauxTVAInput.addEventListener('change', calculerTotaux);
        tauxTVAInput.addEventListener('input', calculerTotaux);
        // Calculer les totaux au chargement avec le taux par défaut
        calculerTotaux();
    } else {
        // Si le champ n'existe pas encore, calculer quand même
        calculerTotaux();
    }
    
    // Si on est en mode modification, charger les articles existants
    {% if is_edit and articles_json %}
    try {
        const articlesData = {{ articles_json|safe }};
        console.log('[MODIFICATION] Chargement des articles:', articlesData);
        
        // Charger les articles avec un délai pour s'assurer que le DOM est prêt
        setTimeout(function() {
            articlesData.forEach(function(article, index) {
                setTimeout(function() {
                    // Utiliser directement les données de l'article
                    addArticleToTable(
                        article.id,
                        article.designation,
                        article.prix_unitaire,
                        0, // Stock non nécessaire pour la modification
                        article.reference || ''
                    );
                    
                    // Mettre à jour la quantité et le prix dans la ligne ajoutée
                    setTimeout(function() {
                        const row = document.querySelector(`tr[data-article-id="${article.id}"]`);
                        if (row) {
                            const quantiteInput = row.querySelector('.quantity-input');
                            const prixInput = row.querySelector('.price-input');
                            if (quantiteInput) quantiteInput.value = article.quantite;
                            if (prixInput) prixInput.value = article.prix_unitaire;
                            updateRowTotal(row);
                            calculerTotaux();
                        }
                    }, 50);
                }, index * 50); // Délai progressif pour éviter les conflits
            });
        }, 200);
    } catch (e) {
        console.error('Erreur lors du chargement des articles en mode modification:', e);
    }
    {% endif %}
});
</script>
{% endblock %}
