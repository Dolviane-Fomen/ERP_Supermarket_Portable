{% extends 'supermarket/achats/dashboard.html' %}
{% load static %}

{% block content %}
<style>
    /* ... (Garder votre style CSS existant, je ne le répète pas pour gagner de la place) ... */
    .filters-section { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .filters-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .filter-group label { display: block; color: #2c3e50; font-weight: 600; margin-bottom: 8px; }
    .filter-group input, .filter-group select { width: 100%; padding: 10px 15px; border: 2px solid #e1e8ed; border-radius: 8px; }
    .table-container { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; }
    .table thead { background: linear-gradient(135deg, #2d1b69 0%, #11998e 100%); color: white; }
    .table th, .table td { padding: 15px; border-bottom: 1px solid #e1e8ed; }
    .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
    .badge-brouillon { background: #ffc107; color: #000; }
    .badge-envoyee { background: #17a2b8; color: white; }
    .badge-en_cours { background: #007bff; color: white; }
    .badge-livree { background: #28a745; color: white; }
    .badge-annulee { background: #dc3545; color: white; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; font-weight: 600; display: inline-block; }
    .btn-view { background: #11998e; color: white; }
    .btn-excel { background: #218838; color: white; } /* Vert Excel */
    .btn-excel:hover { background: #1e7e34; color: white; }
    .action-buttons { display: flex; gap: 5px; }
    .btn-sm { padding: 5px 10px; font-size: 0.8em; }
    .btn-edit { background: #ffc107; color: #000; }
    .btn-pdf { background: #dc3545; color: white; }
    .btn-delete { background: #343a40; color: white; }
</style>

<div class="dashboard-header">
    <h2><i class="fas fa-list-alt" style="color: #11998e;"></i> Consulter les Bons de Commande</h2>
</div>

<div class="filters-section">
    <form method="GET" action="{% url 'consulter_bons_commande' %}" id="filterForm">
        <div class="filters-row">
            <div class="filter-group">
                <label for="statut">Statut</label>
                <select id="statut" name="statut">
                    <option value="">Tous les statuts</option>
                    <option value="brouillon" {% if statut_filter == 'brouillon' %}selected{% endif %}>Brouillon</option>
                    <option value="envoyee" {% if statut_filter == 'envoyee' %}selected{% endif %}>Envoyée</option>
                    <option value="en_cours" {% if statut_filter == 'en_cours' %}selected{% endif %}>En cours</option>
                    <option value="livree" {% if statut_filter == 'livree' %}selected{% endif %}>Livrée</option>
                    <option value="annulee" {% if statut_filter == 'annulee' %}selected{% endif %}>Annulée</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="fournisseur">Fournisseur</label>
                <select id="fournisseur" name="fournisseur">
                    <option value="">Tous les fournisseurs</option>
                    {% for f_nom in liste_fournisseurs %}
                        <option value="{{ f_nom }}" {% if fournisseur_filter == f_nom %}selected{% endif %}>
                            {{ f_nom }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="date_debut">Date début</label>
                <input type="date" id="date_debut" name="date_debut" value="{{ date_debut }}">
            </div>
            <div class="filter-group">
                <label for="date_fin">Date fin</label>
                <input type="date" id="date_fin" name="date_fin" value="{{ date_fin }}">
            </div>

            <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
                <button type="submit" class="btn btn-view" style="flex: 1;">
                    <i class="fas fa-search"></i> Filtrer
                </button>
                
                <a href="{% url 'export_commandes_achats_excel' %}?statut={{ statut_filter|default:'' }}&fournisseur={{ fournisseur_filter|default:'' }}&date_debut={{ date_debut|default:'' }}&date_fin={{ date_fin|default:'' }}" 
                   class="btn btn-excel" style="flex: 1; text-align: center;">
                    <i class="fas fa-file-excel"></i> Export
                </a>
            </div>
        </div>
    </form>
</div>

<div class="table-container">
    {% if bons_commande %}
    <table class="table">
        <thead>
            <tr>
                <th>N° Commande</th>
                <th>Date</th>
                <th>Fournisseur</th>
                <th>Date Livraison</th>
                <th>Total HT</th>
                <th>Total TTC</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for commande in bons_commande %}
            <tr>
                <td><strong>{{ commande.numero_commande }}</strong></td>
                <td>{{ commande.date_commande|date:"d/m/Y" }}</td>
                <td>
                    {{ commande.nom_fournisseur }}
                    {% if commande.delai_paiement %}
                        <br><small class="text-muted"><i class="far fa-clock"></i> Éch: {{ commande.delai_paiement|date:"d/m/Y" }}</small>
                    {% endif %}
                </td>
                <td>{{ commande.date_livraison_prevue|date:"d/m/Y" }}</td>
                <td>{{ commande.total_ht|floatformat:2 }} FCFA</td>
                <td><strong>{{ commande.total_ttc|floatformat:2 }} FCFA</strong></td>
                <td>
                    <span class="badge badge-{{ commande.statut }}">
                        {{ commande.get_statut_display }}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="{% url 'voir_bon_commande' commande.id %}" class="btn btn-view btn-sm" title="Voir">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'modifier_bon_commande' commande.id %}" class="btn btn-edit btn-sm" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'generer_bon_commande_pdf' commande.id %}" class="btn btn-pdf btn-sm" target="_blank" title="PDF">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                        <a href="{% url 'supprimer_bon_commande' commande.id %}" class="btn btn-delete btn-sm" onclick="return confirm('Supprimer ?');" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data">
        <i class="fas fa-inbox" style="font-size: 3em; color: #dee2e6; margin-bottom: 15px;"></i>
        <p>Aucun bon de commande trouvé pour ces critères.</p>
    </div>
    {% endif %}
</div>
{% endblock %}