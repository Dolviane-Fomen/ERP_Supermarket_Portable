name: Deploy to OVH

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permet de d√©clencher manuellement

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy ERP to OVH Server
    
    steps:
    - name: Deploy to OVH via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.OVH_HOST }}
        username: ${{ secrets.OVH_USER }}
        key: ${{ secrets.OVH_SSH_KEY }}
        port: 22
        script: |
          cd ${{ secrets.OVH_PROJECT_PATH }}
          source venv/bin/activate
          
          # Sauvegarder les modifications locales si elles existent
          if ! git diff-index --quiet HEAD -- 2>/dev/null; then
            echo "‚ö†Ô∏è  Modifications locales d√©tect√©es, sauvegarde dans stash..."
            git stash push -m "Auto-stash before deploy $(date +%Y%m%d_%H%M%S)" 2>/dev/null || true
          fi
          
          # R√©cup√©rer et forcer la mise √† jour depuis GitHub
          git fetch origin main
          git reset --hard origin/main
          echo "‚úÖ Code √† jour avec GitHub"
          
          # Installer les d√©pendances
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Migrations et fichiers statiques
          DJANGO_SETTINGS_MODULE=erp_project.settings_production python manage.py migrate --noinput
          DJANGO_SETTINGS_MODULE=erp_project.settings_production python manage.py collectstatic --noinput
          
          # Red√©marrer Gunicorn (plusieurs m√©thodes pour √™tre s√ªr)
          echo "üîÑ Red√©marrage de Gunicorn..."
          
          # M√©thode 1: systemd service erp
          sudo systemctl restart erp 2>/dev/null && echo "‚úÖ Service 'erp' red√©marr√©" || true
          
          # M√©thode 2: systemd service gunicorn
          sudo systemctl restart gunicorn 2>/dev/null && echo "‚úÖ Service 'gunicorn' red√©marr√©" || true
          
          # M√©thode 3: Red√©marrer via processus si systemd n'est pas disponible
          if ! sudo systemctl is-active --quiet erp 2>/dev/null && ! sudo systemctl is-active --quiet gunicorn 2>/dev/null; then
            echo "‚ö†Ô∏è  Aucun service systemd, red√©marrage via processus..."
            pkill -f "gunicorn.*erp_project.wsgi:application" 2>/dev/null || true
            sleep 1
            cd ${{ secrets.OVH_PROJECT_PATH }}
            source venv/bin/activate
            nohup gunicorn --config gunicorn_config.py --daemon erp_project.wsgi:application > /dev/null 2>&1 || true
          fi
          
          sleep 2
          if pgrep -f "gunicorn.*erp_project.wsgi:application" > /dev/null; then
            echo "‚úÖ Gunicorn est en cours d'ex√©cution!"
          else
            echo "‚ö†Ô∏è  V√©rifiez manuellement que Gunicorn est d√©marr√©"
          fi
          
          echo "‚úÖ D√©ploiement termin√© avec succ√®s!"

