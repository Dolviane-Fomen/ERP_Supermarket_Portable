name: Deploy to OVH

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy ERP to OVH Server
    
    steps:
    - name: Deploy to OVH via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.OVH_HOST }}
        username: ${{ secrets.OVH_USER }}
        key: ${{ secrets.OVH_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          set -e  # ArrÃªter en cas d'erreur
          set -x  # Afficher les commandes exÃ©cutÃ©es
          
          echo "ğŸš€ DÃ©but du dÃ©ploiement..."
          echo "ğŸ“‚ Chemin du projet: ${{ secrets.OVH_PROJECT_PATH }}"
          
          # VÃ©rifier que le rÃ©pertoire existe
          if [ ! -d "${{ secrets.OVH_PROJECT_PATH }}" ]; then
            echo "âŒ ERREUR: Le rÃ©pertoire ${{ secrets.OVH_PROJECT_PATH }} n'existe pas!"
            exit 1
          fi
          
          cd ${{ secrets.OVH_PROJECT_PATH }}
          echo "âœ… RÃ©pertoire changÃ© vers: $(pwd)"
          
          # VÃ©rifier que venv existe
          if [ ! -d "venv" ]; then
            echo "âŒ ERREUR: L'environnement virtuel 'venv' n'existe pas!"
            exit 1
          fi
          
          source venv/bin/activate
          echo "âœ… Environnement virtuel activÃ©"
          
          # VÃ©rifier Git
          if ! command -v git &> /dev/null; then
            echo "âŒ ERREUR: Git n'est pas installÃ©!"
            exit 1
          fi
          
          # Sauvegarder les modifications locales si elles existent
          if ! git diff-index --quiet HEAD -- 2>/dev/null; then
            echo "âš ï¸  Modifications locales dÃ©tectÃ©es, sauvegarde dans stash..."
            git stash push -m "Auto-stash before deploy $(date +%Y%m%d_%H%M%S)" 2>/dev/null || true
          fi
          
          # RÃ©cupÃ©rer et forcer la mise Ã  jour depuis GitHub
          echo "ğŸ“¥ RÃ©cupÃ©ration depuis GitHub..."
          git fetch origin main || {
            echo "âŒ ERREUR: Impossible de rÃ©cupÃ©rer depuis GitHub"
            exit 1
          }
          
          git reset --hard origin/main || {
            echo "âŒ ERREUR: Impossible de mettre Ã  jour le code"
            exit 1
          }
          echo "âœ… Code Ã  jour avec GitHub"
          
          # Installer les dÃ©pendances
          echo "ğŸ“¦ Installation des dÃ©pendances..."
          pip install --upgrade pip || {
            echo "âŒ ERREUR: Impossible de mettre Ã  jour pip"
            exit 1
          }
          
          pip install -r requirements.txt || {
            echo "âŒ ERREUR: Impossible d'installer les dÃ©pendances"
            exit 1
          }
          echo "âœ… DÃ©pendances installÃ©es"
          
          # Migrations et fichiers statiques
          echo "ğŸ—„ï¸  ExÃ©cution des migrations..."
          DJANGO_SETTINGS_MODULE=erp_project.settings_production python manage.py migrate --noinput || {
            echo "âŒ ERREUR: Les migrations ont Ã©chouÃ©"
            exit 1
          }
          echo "âœ… Migrations terminÃ©es"
          
          echo "ğŸ“ Collecte des fichiers statiques..."
          DJANGO_SETTINGS_MODULE=erp_project.settings_production python manage.py collectstatic --noinput || {
            echo "âŒ ERREUR: La collecte des fichiers statiques a Ã©chouÃ©"
            exit 1
          }
          echo "âœ… Fichiers statiques collectÃ©s"
          
          # RedÃ©marrer Gunicorn (plusieurs mÃ©thodes pour Ãªtre sÃ»r)
          echo "ğŸ”„ RedÃ©marrage de Gunicorn..."
          
          # MÃ©thode 1: systemd service erp
          if sudo systemctl list-unit-files | grep -q "erp.service"; then
            echo "ğŸ“¦ Tentative de redÃ©marrage via systemd (service erp)..."
            sudo systemctl restart erp && echo "âœ… Service 'erp' redÃ©marrÃ©" || echo "âš ï¸  Service 'erp' non disponible"
          fi
          
          # MÃ©thode 2: systemd service gunicorn
          if sudo systemctl list-unit-files | grep -q "gunicorn.service"; then
            echo "ğŸ“¦ Tentative de redÃ©marrage via systemd (service gunicorn)..."
            sudo systemctl restart gunicorn && echo "âœ… Service 'gunicorn' redÃ©marrÃ©" || echo "âš ï¸  Service 'gunicorn' non disponible"
          fi
          
          # MÃ©thode 3: RedÃ©marrer via processus si systemd n'est pas disponible
          if ! sudo systemctl is-active --quiet erp 2>/dev/null && ! sudo systemctl is-active --quiet gunicorn 2>/dev/null; then
            echo "âš ï¸  Aucun service systemd actif, redÃ©marrage via processus..."
            pkill -f "gunicorn.*erp_project.wsgi:application" 2>/dev/null || true
            sleep 2
            cd ${{ secrets.OVH_PROJECT_PATH }}
            source venv/bin/activate
            nohup gunicorn --config gunicorn_config.py --daemon erp_project.wsgi:application > /tmp/gunicorn.log 2>&1 || {
              echo "âŒ ERREUR: Impossible de dÃ©marrer Gunicorn"
              echo "ğŸ“‹ Logs:"
              cat /tmp/gunicorn.log || true
              exit 1
            }
            echo "âœ… Gunicorn dÃ©marrÃ© via processus"
          fi
          
          sleep 3
          if pgrep -f "gunicorn.*erp_project.wsgi:application" > /dev/null; then
            echo "âœ… Gunicorn est en cours d'exÃ©cution!"
          else
            echo "âš ï¸  ATTENTION: Gunicorn ne semble pas Ãªtre en cours d'exÃ©cution"
            echo "ğŸ’¡ VÃ©rifiez manuellement avec: ps aux | grep gunicorn"
          fi
          
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s!"

